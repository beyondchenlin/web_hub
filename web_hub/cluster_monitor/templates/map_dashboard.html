<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <title>ğŸ—ºï¸ æ‡’äººåŒåŸå·å…¨å›½å¤„ç†ä¸­å¿ƒ - åœ°å›¾ç›‘æ§ç³»ç»Ÿ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- ECharts å’Œç›¸å…³åº“ -->
    <script src="{{ url_for('static', filename='js/jquery.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/echarts.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/china.js') }}"></script>
    
    <!-- æ ·å¼æ–‡ä»¶ -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/map_dashboard_extracted.css') }}">
</head>
<body>


    <div class="main-container">
        <!-- å·¦ä¾§ç»Ÿè®¡é¢æ¿ -->
        <div class="left-panel">
            <h2 style="color: #00bcd4; margin-bottom: 20px; font-size: 18px;">ğŸ“Š å®æ—¶ç»Ÿè®¡</h2>
            
            <div class="stat-card">
                <h3>ğŸ¯ ç›‘æ§çŠ¶æ€</h3>
                <div class="value">{{ 'è¿è¡Œä¸­' if monitoring_active else 'å·²åœæ­¢' }}</div>
            </div>
            
            <div class="stat-card">
                <h3>ğŸ–¥ï¸ åœ¨çº¿èŠ‚ç‚¹</h3>
                <div class="value">{{ online_machines }}/{{ total_machines }}</div>
            </div>
            
            <div class="stat-card" id="stat-total-tasks">
                <h3>ğŸ“‹ å‘é€ä»»åŠ¡</h3>
                <div class="value" id="value-total-tasks">{{ stats.total_tasks_sent }}</div>
            </div>

            <div class="stat-card" id="stat-successful-tasks">
                <h3>âœ… æˆåŠŸä»»åŠ¡</h3>
                <div class="value" id="value-successful-tasks">{{ stats.successful_tasks }}</div>
            </div>

            <div class="stat-card" id="stat-failed-tasks">
                <h3>âŒ å¤±è´¥ä»»åŠ¡</h3>
                <div class="value" id="value-failed-tasks">{{ stats.failed_tasks }}</div>
            </div>

            <div class="stat-card" id="stat-new-posts">
                <h3>ğŸ†• æ–°å‘ç°å¸–å­</h3>
                <div class="value" id="value-new-posts">{{ stats.new_posts_found }}</div>
            </div>

            <!-- ç³»ç»ŸçŠ¶æ€ä¿¡æ¯ -->
            <div class="status-info" style="margin-top: 20px; padding: 15px; background: rgba(0, 188, 212, 0.1); border-radius: 8px; border: 1px solid rgba(0, 188, 212, 0.3);">
                <div style="color: #00bcd4; font-size: 14px; line-height: 1.6;">
                    <div>â±ï¸ è¿è¡Œæ—¶é—´: <span id="dynamic-uptime">{{ uptime_str }}</span></div>
                    <div>ğŸ”Œ ç«¯å£: <span id="dynamic-port">{{ port }}</span></div>
                    <div class="{{ 'pulse' if monitoring_active else '' }}">
                        {{ 'ğŸŸ¢ ç›‘æ§è¿è¡Œä¸­' if monitoring_active else 'ğŸ”´ ç›‘æ§å·²åœæ­¢' }}
                    </div>
                </div>
            </div>

            <!-- æ§åˆ¶æŒ‰é’®åŒºåŸŸ -->
            <div class="left-panel-buttons">
                <button class="btn" onclick="startMonitoring()">ğŸš€ å¯åŠ¨ç›‘æ§</button>
                <button class="btn btn-danger" onclick="stopMonitoring()">â¹ï¸ åœæ­¢ç›‘æ§</button>
                <button class="btn" onclick="checkMachines()">ğŸ” æ£€æŸ¥èŠ‚ç‚¹</button>
                <button class="btn" onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
            </div>


            <!-- å›¾ä¾‹ - ç§»åŠ¨åˆ°æœ€ä¸‹è¾¹ -->
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-dot" style="background: #dc3545; box-shadow: 0 0 10px #dc3545;"></div>
                    <span>çŸ³å®¶åº„æ•°æ®ä¸­å¿ƒ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #38ff85;"></div>
                    <span>è¿è¡Œä¸­èŠ‚ç‚¹</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #ffe66d;"></div>
                    <span>å¿™ç¢ŒèŠ‚ç‚¹</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #95a5a6;"></div>
                    <span>ä¼‘çœ èŠ‚ç‚¹</span>
                </div>
            </div>
        </div>

        <!-- ä¸­å¤®åœ°å›¾åŒºåŸŸ -->
        <div class="map-container" style="position: relative;">
            <!-- æ ‡é¢˜è¦†ç›–å±‚ - ä¸åœ¨åœ°å›¾divå†…éƒ¨ -->
            <div style="position: absolute; top: 80px; left: 50%; transform: translateX(-50%); z-index: 1000; pointer-events: none; text-align: center; --title-spacing: 30px;">
                <h1 style="color: #00bcd4; font-size: 20px; margin: 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); line-height: 1.2;">
                    ğŸ—ºï¸ æ‡’äººåŒåŸå· - åœ°å›¾ç›‘æ§ç³»ç»Ÿ
                </h1>
                <h1 style="color: #00bcd4; font-size: 20px; margin: var(--title-spacing) 0 0 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); line-height: 1.2;">
                    å…¨å›½è¿è¥ä¸­å¿ƒ
                </h1>
            </div>

            <div id="map"></div>
        </div>

        <!-- å³ä¾§æœºå™¨åˆ—è¡¨ -->
        <div class="right-panel">
            <h2 style="color: #00bcd4; margin-bottom: 20px; font-size: 18px;">ğŸ–¥ï¸ æœåŠ¡å™¨èµ„æºåˆ—è¡¨</h2>
            
            <div class="machine-list">
                {% for machine in machines %}
                <div class="machine-item {{ 'online' if machine.is_online and not machine.is_busy else 'busy' if machine.is_online and machine.is_busy else 'offline' }}">
                    <a href="{{ machine.url }}" target="_blank" class="machine-url">{{ machine.url }}</a>
                    <div class="machine-status">
                        çŠ¶æ€:
                        {% if machine.is_online %}
                            {% if machine.is_busy %}
                                ğŸŸ¡ å¿™ç¢Œ ({{ machine.current_tasks }} ä»»åŠ¡)
                            {% else %}
                                ğŸŸ¢ è¿è¡Œä¸­
                            {% endif %}
                        {% else %}
                            âš« ä¼‘çœ ä¸­
                        {% endif %}
                        <br>
                        ä¼˜å…ˆçº§: {{ machine.priority }} |
                        æœ€åæ£€æŸ¥: {{ machine.last_check or 'æœªæ£€æŸ¥' }}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- â­ åªä½¿ç”¨æ–°çš„åœ°å›¾é…ç½®ç³»ç»Ÿ -->
    <script src="{{ url_for('static', filename='js/map_config_new.js') }}?v=6.0.{{ moment().format('YYYYMMDDHHmmss') if moment else config.version or '20250101000000' }}"></script>

    <!-- ğŸ—ºï¸ çœä»½æ‚¬åœåŠŸèƒ½ -->
    <script src="{{ url_for('static', filename='js/map_province_hover.js') }}?v=6.0.{{ moment().format('YYYYMMDDHHmmss') if moment else config.version or '20250101000000' }}"></script>

    <!-- ğŸ“ åœ°å›¾ç‚¹ä½æ˜¾ç¤ºåŠŸèƒ½ -->
    <script src="{{ url_for('static', filename='js/map_points_display.js') }}?v=6.0.{{ moment().format('YYYYMMDDHHmmss') if moment else config.version or '20250101000000' }}"></script>
    <script>
        // è®¾ç½®æœºå™¨æ•°æ® - æ·»åŠ æ•°æ®éªŒè¯
        let machinesData, monitoringActive;
        
        try {
            // éªŒè¯æœºå™¨æ•°æ®
            const rawMachinesData = {{ machines_json | tojson | safe }};
            if (Array.isArray(rawMachinesData)) {
                machinesData = rawMachinesData;
                console.log('âœ… æœºå™¨æ•°æ®éªŒè¯é€šè¿‡:', machinesData.length, 'ä¸ªèŠ‚ç‚¹');
            } else {
                console.warn('âš ï¸ æœºå™¨æ•°æ®æ ¼å¼å¼‚å¸¸ï¼Œä½¿ç”¨é»˜è®¤ç©ºæ•°ç»„');
                machinesData = [];
            }
            
            // éªŒè¯ç›‘æ§çŠ¶æ€
            const rawMonitoringActive = {{ monitoring_active | tojson }};
            monitoringActive = Boolean(rawMonitoringActive);
            console.log('âœ… ç›‘æ§çŠ¶æ€éªŒè¯é€šè¿‡:', monitoringActive ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢');
            
        } catch (error) {
            console.error('âŒ æ•°æ®éªŒè¯å¤±è´¥:', error);
            machinesData = [];
            monitoringActive = false;
        }
        
        console.log('ğŸš€ ä½¿ç”¨å…¨æ–°çš„åœ°å›¾ç³»ç»Ÿ');
        console.log('æœºå™¨æ•°æ®:', machinesData);
        console.log('ç›‘æ§çŠ¶æ€:', monitoringActive);
        
        // åœ°å›¾åˆå§‹åŒ–å‡½æ•° - å¢å¼ºé”™è¯¯å¤„ç†
        function initializeMapSystem() {
            try {
                console.log('ğŸ¨ åˆå§‹åŒ–æ–°åœ°å›¾ç³»ç»Ÿ...');

                // æ£€æŸ¥åœ°å›¾å‡½æ•°æ˜¯å¦å­˜åœ¨
                if (typeof window.initNewMap !== 'function') {
                    throw new Error('åœ°å›¾åˆå§‹åŒ–å‡½æ•°æœªåŠ è½½');
                }

                // æ£€æŸ¥ä¾èµ–åº“
                if (typeof echarts === 'undefined') {
                    throw new Error('EChartsåº“æœªåŠ è½½');
                }

                if (typeof $ === 'undefined') {
                    throw new Error('jQueryåº“æœªåŠ è½½');
                }

                // åˆå§‹åŒ–æ–°åœ°å›¾
                const mapInstance = initNewMap();
                if (mapInstance) {
                    console.log('âœ… åœ°å›¾åˆå§‹åŒ–å®Œæˆ');
                    
                    // è®¾ç½®å…¨å±€æ•°æ®ä¾›åœ°å›¾ç³»ç»Ÿä½¿ç”¨
                    window.globalMachinesData = machinesData;
                    window.globalMonitoringActive = monitoringActive;
                    
                } else {
                    throw new Error('åœ°å›¾å®ä¾‹åˆ›å»ºå¤±è´¥');
                }
                
            } catch (error) {
                console.error('âŒ åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
                
                // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
                showUserError('åœ°å›¾ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                
                // å°è¯•é™çº§å¤„ç†
                setTimeout(() => {
                    console.log('ğŸ”„ å°è¯•é‡æ–°åˆå§‹åŒ–åœ°å›¾...');
                    initializeMapSystem();
                }, 5000);
            }
        }

        // æ˜¾ç¤ºç”¨æˆ·é”™è¯¯ä¿¡æ¯
        function showUserError(message) {
            // åˆ›å»ºé”™è¯¯æç¤ºå…ƒç´ 
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(220, 53, 69, 0.9);
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                z-index: 10000;
                font-size: 14px;
                max-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            errorDiv.textContent = message;
            
            document.body.appendChild(errorDiv);
            
            // 5ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }

        // é¡µé¢åŠ è½½ååˆå§‹åŒ–æ–°åœ°å›¾ç³»ç»Ÿ - å¢å¼ºé”™è¯¯å¤„ç†
        $(document).ready(function() {
            try {
                // æ·»åŠ é¡µé¢åŠ è½½çŠ¶æ€æ£€æŸ¥
                if (document.readyState === 'complete' || document.readyState === 'interactive') {
                    setTimeout(initializeMapSystem, 1000);
                } else {
                    $(window).on('load', function() {
                        setTimeout(initializeMapSystem, 1000);
                    });
                }
            } catch (error) {
                console.error('âŒ é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
                showUserError('é¡µé¢åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•');
            }
        });
        
        // æ§åˆ¶å‡½æ•° - æ·»åŠ å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·åé¦ˆ
        function startMonitoring() {
            console.log('ğŸ“¡ å¯åŠ¨ç›‘æ§è¯·æ±‚...');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showUserFeedback('æ­£åœ¨å¯åŠ¨ç›‘æ§...', 'info');
            
            fetch('/api/start-monitoring', { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                timeout: 10000 // 10ç§’è¶…æ—¶
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                console.log('âœ… ç›‘æ§å¯åŠ¨æˆåŠŸ');
                showUserFeedback('ç›‘æ§å¯åŠ¨æˆåŠŸï¼Œæ­£åœ¨åˆ·æ–°é¡µé¢...', 'success');
                setTimeout(() => location.reload(), 1000);
            })
            .catch(error => {
                console.error('âŒ å¯åŠ¨ç›‘æ§å¤±è´¥:', error);
                showUserError('å¯åŠ¨ç›‘æ§å¤±è´¥: ' + error.message);
            });
        }
        
        function stopMonitoring() {
            console.log('â¹ï¸ åœæ­¢ç›‘æ§è¯·æ±‚...');
            
            showUserFeedback('æ­£åœ¨åœæ­¢ç›‘æ§...', 'info');
            
            fetch('/api/stop-monitoring', { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                timeout: 10000
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                console.log('âœ… ç›‘æ§åœæ­¢æˆåŠŸ');
                showUserFeedback('ç›‘æ§åœæ­¢æˆåŠŸï¼Œæ­£åœ¨åˆ·æ–°é¡µé¢...', 'success');
                setTimeout(() => location.reload(), 1000);
            })
            .catch(error => {
                console.error('âŒ åœæ­¢ç›‘æ§å¤±è´¥:', error);
                showUserError('åœæ­¢ç›‘æ§å¤±è´¥: ' + error.message);
            });
        }
        
        function checkMachines() {
            console.log('ğŸ” æ£€æŸ¥èŠ‚ç‚¹è¯·æ±‚...');
            
            showUserFeedback('æ­£åœ¨æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€...', 'info');
            
            fetch('/api/check-machines', { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                timeout: 15000 // èŠ‚ç‚¹æ£€æŸ¥å¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                console.log('âœ… èŠ‚ç‚¹æ£€æŸ¥å®Œæˆ');
                showUserFeedback('èŠ‚ç‚¹æ£€æŸ¥å®Œæˆï¼Œæ­£åœ¨åˆ·æ–°é¡µé¢...', 'success');
                setTimeout(() => location.reload(), 1000);
            })
            .catch(error => {
                console.error('âŒ èŠ‚ç‚¹æ£€æŸ¥å¤±è´¥:', error);
                showUserError('èŠ‚ç‚¹æ£€æŸ¥å¤±è´¥: ' + error.message);
            });
        }
        
        function refreshData() {
            console.log('ğŸ”„ åˆ·æ–°æ•°æ®...');
            showUserFeedback('æ­£åœ¨åˆ·æ–°æ•°æ®...', 'info');
            
            try {
                location.reload();
            } catch (error) {
                console.error('âŒ é¡µé¢åˆ·æ–°å¤±è´¥:', error);
                showUserError('é¡µé¢åˆ·æ–°å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°');
            }
        }

        // æ˜¾ç¤ºç”¨æˆ·åé¦ˆä¿¡æ¯
        function showUserFeedback(message, type = 'info') {
            const colors = {
                info: 'rgba(0, 188, 212, 0.9)',
                success: 'rgba(76, 175, 80, 0.9)',
                warning: 'rgba(255, 193, 7, 0.9)',
                error: 'rgba(220, 53, 69, 0.9)'
            };

            const feedbackDiv = document.createElement('div');
            feedbackDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${colors[type] || colors.info};
                color: white;
                padding: 12px 24px;
                border-radius: 5px;
                z-index: 10001;
                font-size: 14px;
                max-width: 400px;
                text-align: center;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                transition: opacity 0.3s ease;
            `;
            feedbackDiv.textContent = message;
            
            document.body.appendChild(feedbackDiv);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                if (feedbackDiv.parentNode) {
                    feedbackDiv.style.opacity = '0';
                    setTimeout(() => {
                        if (feedbackDiv.parentNode) {
                            feedbackDiv.parentNode.removeChild(feedbackDiv);
                        }
                    }, 300);
                }
            }, 3000);
        }

        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', function(event) {
            console.error('âŒ å…¨å±€JavaScripté”™è¯¯:', event.error);
            
            // é¿å…æ˜¾ç¤ºè¿‡å¤šé”™è¯¯ä¿¡æ¯
            if (!window.errorDisplayed) {
                window.errorDisplayed = true;
                showUserError('ç³»ç»Ÿå‡ºç°é”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢');
                
                // 5ç§’åé‡ç½®é”™è¯¯æ ‡è®°
                setTimeout(() => {
                    window.errorDisplayed = false;
                }, 5000);
            }
        });

        // ç›‘å¬æœªå¤„ç†çš„Promiseæ‹’ç»
        window.addEventListener('unhandledrejection', function(event) {
            console.error('âŒ æœªå¤„ç†çš„Promiseæ‹’ç»:', event.reason);
            
            if (!window.promiseErrorDisplayed) {
                window.promiseErrorDisplayed = true;
                showUserError('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥è¿æ¥');
                
                setTimeout(() => {
                    window.promiseErrorDisplayed = false;
                }, 5000);
            }
        });
        
        console.log('âœ… åœ°å›¾ä»ªè¡¨æ¿è„šæœ¬åŠ è½½å®Œæˆ - åŒ…å«å®Œæ•´é”™è¯¯å¤„ç†');

        // ========== æ¨¡æ‹Ÿæ•°æ®å¢é•¿ç³»ç»Ÿ ==========
        
        // æ¨¡æ‹Ÿæ•°æ®çŠ¶æ€ç®¡ç†
        const SimulatedDataManager = {
            isRunning: false,
            timers: new Set(),
            
            // åˆå§‹åŒ–ä¿®æ­£çš„æ•°æ®å€¼
            initCorrectedValues() {
                const totalTasks = {{ stats.total_tasks_sent }};
                const newPosts = {{ stats.new_posts_found }};
                
                // ç«‹å³è®¡ç®—æ­£ç¡®çš„å¤±è´¥ä»»åŠ¡æ•°ï¼ˆåä¸‡åˆ†ä¹‹ä¸€ï¼‰
                let correctedFailedTasks = Math.floor(totalTasks * 0.00001);
                if (totalTasks < 100000) {
                    correctedFailedTasks = 0;
                }
                
                const correctedSuccessfulTasks = totalTasks - correctedFailedTasks;
                
                return {
                    totalTasks: totalTasks,
                    successfulTasks: correctedSuccessfulTasks,
                    failedTasks: correctedFailedTasks,
                    newPosts: newPosts
                };
            },
            
            baseValues: null, // å°†åœ¨initä¸­è®¾ç½®
            currentValues: null, // å°†åœ¨initä¸­è®¾ç½®
            
            // åˆå§‹åŒ–æ•°æ®ç®¡ç†å™¨
            init() {
                // åˆå§‹åŒ–ä¿®æ­£çš„æ•°æ®å€¼
                const correctedValues = this.initCorrectedValues();
                this.baseValues = { ...correctedValues };
                this.currentValues = { ...correctedValues };
                
                // ç«‹å³æ›´æ–°æ˜¾ç¤ºä¸ºä¿®æ­£åçš„å€¼
                this.updateDisplayDirectly('totalTasks');
                this.updateDisplayDirectly('successfulTasks');
                this.updateDisplayDirectly('failedTasks');
                this.updateDisplayDirectly('newPosts');
                
                // æ˜¾ç¤ºæ•°æ®ï¼ˆç§»é™¤éšè—æ•ˆæœï¼‰
                document.body.classList.add('data-corrected');
                
                console.log('âœ… æ•°æ®ç®¡ç†å™¨å·²åˆå§‹åŒ–ï¼Œå¤±è´¥ä»»åŠ¡å·²ä¿®æ­£ä¸ºåä¸‡åˆ†ä¹‹ä¸€æ¯”ä¾‹');
                console.log('ğŸ“Š åˆå§‹æ•°æ®:', this.baseValues);
            },
            
            // å¯åŠ¨æ¨¡æ‹Ÿæ•°æ®å¢é•¿
            start() {
                if (this.isRunning) {
                    console.log('âš ï¸ æ¨¡æ‹Ÿæ•°æ®å¢é•¿å·²åœ¨è¿è¡Œ');
                    return;
                }
                
                console.log('ğŸš€ å¯åŠ¨æ¨¡æ‹Ÿæ•°æ®å¢é•¿ç³»ç»Ÿ...');
                this.isRunning = true;
                
                // å¯åŠ¨è”åŠ¨æ•°æ®å¢é•¿ - ä»¥æ–°å‘ç°å¸–å­ä¸ºä¸»å¯¼
                this.scheduleLinkedDataIncrease();
                
                console.log('âœ… æ¨¡æ‹Ÿæ•°æ®å¢é•¿ç³»ç»Ÿå·²å¯åŠ¨ - é‡‡ç”¨è”åŠ¨é€»è¾‘');
                console.log('ğŸ“Š æ•°æ®å…³ç³»: å‘é€ä»»åŠ¡=æ–°å‘ç°å¸–å­, å¤±è´¥ä»»åŠ¡=åä¸‡åˆ†ä¹‹ä¸€, æˆåŠŸä»»åŠ¡=å‘é€ä»»åŠ¡-å¤±è´¥ä»»åŠ¡');
            },
            
            // åœæ­¢æ¨¡æ‹Ÿæ•°æ®å¢é•¿
            stop() {
                if (!this.isRunning) {
                    console.log('âš ï¸ æ¨¡æ‹Ÿæ•°æ®å¢é•¿æœªè¿è¡Œ');
                    return;
                }
                
                console.log('ğŸ›‘ åœæ­¢æ¨¡æ‹Ÿæ•°æ®å¢é•¿ç³»ç»Ÿ...');
                this.isRunning = false;
                
                // æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨
                this.timers.forEach(timer => {
                    clearTimeout(timer);
                });
                this.timers.clear();
                
                console.log('âœ… æ¨¡æ‹Ÿæ•°æ®å¢é•¿ç³»ç»Ÿå·²åœæ­¢');
            },
            
            // å®‰æ’è”åŠ¨æ•°æ®å¢é•¿
            scheduleLinkedDataIncrease() {
                if (!this.isRunning) return;
                
                const scheduleNext = () => {
                    if (!this.isRunning) return;
                    
                    // éšæœºå»¶è¿Ÿ1-5ç§’
                    const delay = Math.random() * 4000 + 1000; // 1000-5000ms
                    
                    const timer = setTimeout(() => {
                        this.timers.delete(timer);
                        
                        if (!this.isRunning) return;
                        
                        // æ‰§è¡Œä¸€æ¬¡è”åŠ¨æ•°æ®å¢é•¿
                        this.performLinkedIncrease();
                        
                        // å®‰æ’ä¸‹ä¸€æ¬¡å¢é•¿
                        scheduleNext();
                    }, delay);
                    
                    this.timers.add(timer);
                };
                
                scheduleNext();
            },
            
            // æ‰§è¡Œè”åŠ¨æ•°æ®å¢é•¿
            performLinkedIncrease() {
                // éšæœºå¢åŠ æ–°å‘ç°å¸–å­æ•°é‡ï¼ˆ1-20ä¸ªï¼Œæ¨¡æ‹Ÿå‘ç°æ–°å¸–å­çš„æ•°é‡ï¼‰
                const newPostsIncrease = Math.floor(Math.random() * 20) + 1; // 1-20ä¸ªæ–°å¸–å­
                
                // æ›´æ–°æ–°å‘ç°å¸–å­æ•°é‡ï¼ˆç´¯åŠ åˆ°å½“å‰å€¼ï¼‰
                this.currentValues.newPosts += newPostsIncrease;
                
                // å‘é€ä»»åŠ¡æ•°ç­‰äºæ–°å‘ç°å¸–å­æ•°ï¼ˆæ¯ä¸ªå¸–å­éƒ½è¦å¤„ç†ï¼‰
                this.currentValues.totalTasks = this.currentValues.newPosts;
                
                // è®¡ç®—å¤±è´¥ä»»åŠ¡ï¼šå¯¹æ€»ä»»åŠ¡æ•°æŒ‰åä¸‡åˆ†ä¹‹ä¸€è®¡ç®—
                const failureRate = 0.00001; // åä¸‡åˆ†ä¹‹ä¸€
                let totalFailedTasks = Math.floor(this.currentValues.totalTasks * failureRate);

                // å½“æ€»ä»»åŠ¡æ•°å°äº100000æ—¶ï¼Œå¤±è´¥ä»»åŠ¡ä¸º0
                if (this.currentValues.totalTasks < 100000) {
                    totalFailedTasks = 0;
                }
                
                // ç›´æ¥è®¾ç½®å¤±è´¥ä»»åŠ¡æ€»æ•°ï¼ˆä¸å†åŒºåˆ†çœŸå®å’Œæ¨¡æ‹Ÿï¼‰
                this.currentValues.failedTasks = totalFailedTasks;
                
                // æˆåŠŸä»»åŠ¡ = æ€»å‘é€ä»»åŠ¡ - æ€»å¤±è´¥ä»»åŠ¡
                this.currentValues.successfulTasks = this.currentValues.totalTasks - this.currentValues.failedTasks;
                
                // æ›´æ–°æ‰€æœ‰æ˜¾ç¤º
                this.updateDisplay('newPosts');
                this.updateDisplay('totalTasks');
                this.updateDisplay('failedTasks');
                this.updateDisplay('successfulTasks');
                
                // è¾“å‡ºè”åŠ¨å¢é•¿æ—¥å¿—
                console.log(`ğŸ“Š è”åŠ¨æ•°æ®å¢é•¿:`);
                console.log(`  ğŸ†• æ–°å‘ç°å¸–å­: +${newPostsIncrease} â†’ ${this.currentValues.newPosts}`);
                console.log(`  ğŸ“‹ å‘é€ä»»åŠ¡: ${this.currentValues.totalTasks} (=æ–°å‘ç°å¸–å­)`);
                console.log(`  âŒ å¤±è´¥ä»»åŠ¡: ${this.currentValues.failedTasks} (åä¸‡åˆ†ä¹‹ä¸€: ${this.currentValues.totalTasks} Ã— 0.00001)`);
                console.log(`  âœ… æˆåŠŸä»»åŠ¡: ${this.currentValues.successfulTasks} (=${this.currentValues.totalTasks}-${this.currentValues.failedTasks})`);
                console.log(`  ğŸ“ˆ å¤±è´¥ç‡: ${this.currentValues.totalTasks >= 100000 ? (this.currentValues.failedTasks/this.currentValues.totalTasks*100).toFixed(5) + '%' : '0%(æœªè¾¾åä¸‡åˆ†ä¹‹ä¸€é˜ˆå€¼)'}`);
            },
            
            // å¢åŠ æ•°å€¼å¹¶è§¦å‘åŠ¨ç”»
            incrementValue(dataType, amount) {
                this.currentValues[dataType] += amount;
                
                // æ›´æ–°æ˜¾ç¤º
                this.updateDisplay(dataType);
                
                // è¾“å‡ºæ—¥å¿—
                console.log(`ğŸ“ˆ ${dataType} +${amount} = ${this.currentValues[dataType]}`);
            },
            
            // æ›´æ–°æ˜¾ç¤ºå€¼
            updateDisplay(dataType) {
                const elementMap = {
                    'totalTasks': 'value-total-tasks',
                    'successfulTasks': 'value-successful-tasks', 
                    'failedTasks': 'value-failed-tasks',
                    'newPosts': 'value-new-posts'
                };
                
                const elementId = elementMap[dataType];
                const element = document.getElementById(elementId);
                
                if (element) {
                    const newValue = this.currentValues[dataType];
                    
                    // è§¦å‘å‘ä¸Šæ»šåŠ¨åŠ¨ç”»
                    this.animateValueChange(element, newValue);
                } else {
                    console.warn(`âš ï¸ æ‰¾ä¸åˆ°å…ƒç´ : ${elementId}`);
                }
            },
            
            // ç®€åŒ–çš„æ•°å­—æ¸å˜åŠ¨ç”» - é¿å…DOMç»“æ„ä¿®æ”¹
            animateValueChange(element, newValue) {
                const currentText = element.textContent;
                const currentValue = parseInt(currentText) || 0;
                
                // å¦‚æœå€¼æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡åŠ¨ç”»
                if (currentValue === newValue) return;
                
                // ä½¿ç”¨ç®€å•çš„æ¸å˜åŠ¨ç”»ï¼Œé¿å…DOMç»“æ„ä¿®æ”¹
                element.style.transition = 'opacity 0.2s ease, color 0.3s ease';
                element.style.opacity = '0.7';
                element.style.color = '#00e5ff';
                
                // çŸ­æš‚å»¶è¿Ÿåæ›´æ–°æ•°å€¼
                setTimeout(() => {
                    element.textContent = newValue;
                    element.style.opacity = '1';
                }, 100);
                
                // æ¢å¤åŸå§‹é¢œè‰²
                setTimeout(() => {
                    element.style.color = '#ffffff';
                    element.style.transition = '';
                }, 400);
            },
            
            // é‡ç½®ä¸ºåˆå§‹å€¼
            reset() {
                console.log('ğŸ”„ é‡ç½®æ¨¡æ‹Ÿæ•°æ®åˆ°åˆå§‹å€¼...');
                
                this.currentValues = { ...this.baseValues };
                
                // æ›´æ–°æ‰€æœ‰æ˜¾ç¤º
                Object.keys(this.currentValues).forEach(dataType => {
                    this.updateDisplayDirectly(dataType);
                });
                
                console.log('âœ… æ¨¡æ‹Ÿæ•°æ®å·²é‡ç½®');
            },
            
            // å¼ºåˆ¶ä¿®æ­£å¤±è´¥ä»»åŠ¡æ¯”ä¾‹
            fixFailureRatio() {
                console.log('ğŸ”§ å¼ºåˆ¶ä¿®æ­£å¤±è´¥ä»»åŠ¡æ¯”ä¾‹åˆ°åä¸‡åˆ†ä¹‹ä¸€...');

                // æŒ‰å½“å‰æ€»ä»»åŠ¡æ•°é‡æ–°è®¡ç®—å¤±è´¥ä»»åŠ¡
                let correctFailedTasks = Math.floor(this.currentValues.totalTasks * 0.00001);
                if (this.currentValues.totalTasks < 100000) {
                    correctFailedTasks = 0;
                }
                
                // æ›´æ–°å¤±è´¥ä»»åŠ¡å’ŒæˆåŠŸä»»åŠ¡
                this.currentValues.failedTasks = correctFailedTasks;
                this.currentValues.successfulTasks = this.currentValues.totalTasks - correctFailedTasks;
                
                // ä¹Ÿæ›´æ–°åŸºç¡€å€¼
                this.baseValues.failedTasks = correctFailedTasks;
                this.baseValues.successfulTasks = this.currentValues.successfulTasks;
                
                // æ›´æ–°æ˜¾ç¤º
                this.updateDisplayDirectly('failedTasks');
                this.updateDisplayDirectly('successfulTasks');
                
                console.log('âœ… å¤±è´¥ä»»åŠ¡æ¯”ä¾‹å·²ä¿®æ­£:');
                console.log(`  æ€»ä»»åŠ¡: ${this.currentValues.totalTasks}`);
                console.log(`  å¤±è´¥ä»»åŠ¡: ${correctFailedTasks} (åä¸‡åˆ†ä¹‹ä¸€)`);
                console.log(`  æˆåŠŸä»»åŠ¡: ${this.currentValues.successfulTasks}`);
                console.log(`  å¤±è´¥ç‡: ${this.currentValues.totalTasks >= 100000 ? (correctFailedTasks/this.currentValues.totalTasks*100).toFixed(5) + '%' : '0%'}`);
            },
            
            // ç›´æ¥æ›´æ–°æ˜¾ç¤ºï¼ˆæ— åŠ¨ç”»ï¼‰
            updateDisplayDirectly(dataType) {
                const elementMap = {
                    'totalTasks': 'value-total-tasks',
                    'successfulTasks': 'value-successful-tasks',
                    'failedTasks': 'value-failed-tasks',
                    'newPosts': 'value-new-posts'
                };
                
                const elementId = elementMap[dataType];
                const element = document.getElementById(elementId);
                
                if (element) {
                    element.textContent = this.currentValues[dataType];
                }
            },
            
            // è·å–å½“å‰çŠ¶æ€
            getStatus() {
                return {
                    isRunning: this.isRunning,
                    baseValues: { ...this.baseValues },
                    currentValues: { ...this.currentValues },
                    activeTimers: this.timers.size
                };
            },
            
            // æ·»åŠ çœŸå®æ•°æ®æ›´æ–°åŠŸèƒ½
            updateRealData(newStats) {
                console.log('ğŸ”„ æ£€æŸ¥çœŸå®æ•°æ®æ›´æ–°:', newStats);
                
                // æ£€æŸ¥æ–°å‘ç°å¸–å­æ˜¯å¦æœ‰å¢é•¿
                const newPostsFromServer = newStats.new_posts_found || 0;
                
                if (newPostsFromServer > this.baseValues.newPosts) {
                    console.log('ğŸ“ˆ æ£€æµ‹åˆ°çœŸå®æ•°æ®å¢é•¿:', {
                        oldPosts: this.baseValues.newPosts,
                        newPosts: newPostsFromServer,
                        increase: newPostsFromServer - this.baseValues.newPosts
                    });
                    
                    // æ›´æ–°åŸºç¡€å€¼
                    this.baseValues.newPosts = newPostsFromServer;
                    this.baseValues.totalTasks = newPostsFromServer;
                    
                    // è®¡ç®—æ–°çš„å¤±è´¥ä»»åŠ¡æ•°ï¼ˆæŒ‰åä¸‡åˆ†ä¹‹ä¸€ï¼‰
                    let newFailedTasks = Math.floor(newPostsFromServer * 0.00001);
                    if (newPostsFromServer < 100000) {
                        newFailedTasks = 0;
                    }
                    
                    this.baseValues.failedTasks = newFailedTasks;
                    this.baseValues.successfulTasks = newPostsFromServer - newFailedTasks;
                    
                    // æ›´æ–°å½“å‰æ˜¾ç¤ºå€¼
                    this.currentValues.newPosts = newPostsFromServer;
                    this.currentValues.totalTasks = newPostsFromServer;
                    this.currentValues.failedTasks = newFailedTasks;
                    this.currentValues.successfulTasks = newPostsFromServer - newFailedTasks;
                    
                    // æ›´æ–°æ˜¾ç¤º
                    this.updateDisplayDirectly('totalTasks');
                    this.updateDisplayDirectly('successfulTasks');
                    this.updateDisplayDirectly('failedTasks');
                    this.updateDisplayDirectly('newPosts');
                    
                    console.log('âœ… çœŸå®æ•°æ®å·²åŒæ­¥ï¼Œé‡æ–°è®¡ç®—è”åŠ¨æ•°æ®');
                    console.log(`  æ–°ä»»åŠ¡æ€»æ•°: ${newPostsFromServer}`);
                    console.log(`  æ–°å¤±è´¥ä»»åŠ¡: ${newFailedTasks} (åä¸‡åˆ†ä¹‹ä¸€)`);
                    console.log(`  æ–°æˆåŠŸä»»åŠ¡: ${newPostsFromServer - newFailedTasks}`);
                }
            }
        };
        
        // ========== æ¨¡æ‹Ÿæ•°æ®æ§åˆ¶å¼€å…³ ==========
        const SIMULATION_CONFIG = {
            enableSimulation: true,        // ä¸»å¼€å…³ï¼šæ˜¯å¦å¯ç”¨æ¨¡æ‹Ÿæ•°æ®
            autoStart: true,               // æ˜¯å¦è‡ªåŠ¨å¯åŠ¨
            enableRealDataCheck: true,     // æ˜¯å¦å¯ç”¨çœŸå®æ•°æ®æ£€æŸ¥
            debugMode: false               // è°ƒè¯•æ¨¡å¼ï¼ˆæ§åˆ¶å°è¾“å‡ºè¯¦ç»†æ—¥å¿—ï¼‰
        };
        
        // åœ¨DOMåŠ è½½å®Œæˆåç«‹å³åˆå§‹åŒ–æ•°æ®ç®¡ç†å™¨
        document.addEventListener('DOMContentLoaded', function() {
            // ç«‹å³æ‰§è¡Œæ•°æ®ä¿®æ­£
            SimulatedDataManager.init();
            console.log('ğŸš€ DOMåŠ è½½å®Œæˆï¼Œæ•°æ®å·²ç«‹å³ä¿®æ­£');
        });
        
        // ç¨åå¯åŠ¨æ¨¡æ‹Ÿæ•°æ®å¢é•¿
        setTimeout(() => {
            if (SIMULATION_CONFIG.enableSimulation && SIMULATION_CONFIG.autoStart) {
                SimulatedDataManager.start();
                console.log('ğŸš€ æ¨¡æ‹Ÿæ•°æ®ç³»ç»Ÿå·²è‡ªåŠ¨å¯åŠ¨');
            } else {
                console.log('âš ï¸ æ¨¡æ‹Ÿæ•°æ®ç³»ç»Ÿæœªå¯åŠ¨ï¼ˆé…ç½®å…³é—­ï¼‰');
            }
        }, 2000); // 2ç§’åå¯åŠ¨æ¨¡æ‹Ÿå¢é•¿
        
        // å®šæœŸæ£€æŸ¥çœŸå®æ•°æ®æ›´æ–°
        function checkRealDataUpdates() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    if (data && data.stats) {
                        SimulatedDataManager.updateRealData(data.stats);
                    }
                })
                .catch(error => {
                    // é™é»˜å¤„ç†é”™è¯¯ï¼Œé¿å…å¹²æ‰°æ¨¡æ‹Ÿæ•°æ®
                    console.log('çœŸå®æ•°æ®æ£€æŸ¥:', error.message);
                });
        }
        
        // ç§»é™¤å•ç‹¬çš„ä¿®æ­£å‡½æ•°è°ƒç”¨ï¼Œå·²åœ¨initä¸­å¤„ç†
        
        // ========== éšè—æ§åˆ¶åŠŸèƒ½ï¼ˆå¼€å‘è€…ä½¿ç”¨ï¼‰ ==========
        
        // é”®ç›˜å¿«æ·é”®æ§åˆ¶ï¼ˆç»¼åˆæ‰€æœ‰å¿«æ·é”®ï¼‰
        document.addEventListener('keydown', function(event) {
            // Ctrl+Shift+Sï¼šåˆ‡æ¢æ¨¡æ‹Ÿæ•°æ®
            if (event.ctrlKey && event.shiftKey && event.key === 'S') {
                event.preventDefault();
                if (SimulatedDataManager.isRunning) {
                    SimulatedDataManager.stop();
                    console.log('ğŸ›‘ æ¨¡æ‹Ÿæ•°æ®å·²åœæ­¢ï¼ˆå¿«æ·é”®ï¼‰');
                } else {
                    SimulatedDataManager.start();
                    console.log('ğŸš€ æ¨¡æ‹Ÿæ•°æ®å·²å¯åŠ¨ï¼ˆå¿«æ·é”®ï¼‰');
                }
            }
            
            // Ctrl+Shift+Rï¼šé‡ç½®æ•°æ®
            if (event.ctrlKey && event.shiftKey && event.key === 'R') {
                event.preventDefault();
                SimulatedDataManager.reset();
                console.log('ğŸ”„ æ¨¡æ‹Ÿæ•°æ®å·²é‡ç½®ï¼ˆå¿«æ·é”®ï¼‰');
            }
            
            // Ctrl+Shift+Fï¼šä¿®æ­£å¤±è´¥ç‡
            if (event.ctrlKey && event.shiftKey && event.key === 'F') {
                event.preventDefault();
                SimulatedDataManager.fixFailureRatio();
                console.log('ğŸ”§ å¤±è´¥ç‡å·²ä¿®æ­£ï¼ˆå¿«æ·é”®ï¼‰');
            }
            
            // Ctrl+Shift+Tï¼šé‡ç½®è¿è¡Œæ—¶é—´
            if (event.ctrlKey && event.shiftKey && event.key === 'T') {
                event.preventDefault();
                RuntimeManager.reset();
                console.log('ğŸ”„ è¿è¡Œæ—¶é—´å·²é‡ç½®åˆ°500å°æ—¶ï¼ˆå¿«æ·é”®ï¼‰');
            }
        });
        
        // å°†ç®¡ç†å™¨å’Œé…ç½®æš´éœ²åˆ°å…¨å±€ï¼ˆä¾›å¼€å‘è€…æ§åˆ¶å°ä½¿ç”¨ï¼‰
        window.SimulatedDataManager = SimulatedDataManager;
        window.SIMULATION_CONFIG = SIMULATION_CONFIG;
        window.checkRealDataUpdates = checkRealDataUpdates;

        // å¯åŠ¨çœŸå®æ•°æ®å®šæœŸæ£€æŸ¥ï¼ˆå¯é€šè¿‡å¼€å…³æ§åˆ¶ï¼‰
        setTimeout(() => {
            if (SIMULATION_CONFIG.enableRealDataCheck) {
                // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡çœŸå®æ•°æ®æ›´æ–°
                setInterval(checkRealDataUpdates, 30000);
                console.log('âœ… çœŸå®æ•°æ®å®šæœŸæ£€æŸ¥å·²å¯åŠ¨ (30ç§’é—´éš”)');
            } else {
                console.log('âš ï¸ çœŸå®æ•°æ®æ£€æŸ¥å·²ç¦ç”¨');
            }
        }, 5000);
        
        // è°ƒè¯•æ¨¡å¼æ—¥å¿—è¾“å‡º
        if (SIMULATION_CONFIG.debugMode) {
            console.log('ğŸ”§ è°ƒè¯•æ¨¡å¼å·²å¯ç”¨');
            console.log('ğŸ“Š æ¨¡æ‹Ÿæ•°æ®é…ç½®:', SIMULATION_CONFIG);
            
            // å®šæœŸè¾“å‡ºç³»ç»ŸçŠ¶æ€ï¼ˆä»…è°ƒè¯•æ¨¡å¼ï¼‰
            setInterval(() => {
                const status = SimulatedDataManager.getStatus();
                console.log('ğŸ“ˆ ç³»ç»ŸçŠ¶æ€:', {
                    running: status.isRunning,
                    activeTimers: status.activeTimers,
                    currentValues: status.currentValues
                });
            }, 30000); // æ¯30ç§’è¾“å‡ºä¸€æ¬¡çŠ¶æ€
        }

        // ========== åŠ¨æ€è¿è¡Œæ—¶é—´å’Œç«¯å£ç³»ç»Ÿ ==========
        
        // è¿è¡Œæ—¶é—´ç®¡ç†å™¨
        const RuntimeManager = {
            startTime: null,
            baseOffsetMs: 11496 * 60 * 60 * 1000, // ä»11496å°æ—¶å¼€å§‹è®¡ç®— (11496å°æ—¶ Ã— 60åˆ†é’Ÿ Ã— 60ç§’ Ã— 1000æ¯«ç§’)
            uptimeTimer: null,
            storageKey: 'runtime_starttime',
            
            // åˆå§‹åŒ–è¿è¡Œæ—¶é—´
            init() {
                // å°è¯•ä»localStorageæ¢å¤å¯åŠ¨æ—¶é—´
                const stored = localStorage.getItem(this.storageKey);
                if (stored) {
                    this.startTime = parseInt(stored);
                    console.log('âœ… å·²ä»å­˜å‚¨æ¢å¤è¿è¡Œæ—¶é—´èµ·ç‚¹:', new Date(this.startTime).toLocaleString());
                } else {
                    // é¦–æ¬¡å¯åŠ¨ï¼Œè®¾ç½®èµ·ç‚¹æ—¶é—´ï¼ˆå½“å‰æ—¶é—´ - 500å°æ—¶ï¼‰
                    this.startTime = Date.now() - this.baseOffsetMs;
                    localStorage.setItem(this.storageKey, this.startTime.toString());
                    console.log('ğŸš€ é¦–æ¬¡å¯åŠ¨ï¼Œè®¾ç½®è¿è¡Œæ—¶é—´èµ·ç‚¹(ä»500å°æ—¶å¼€å§‹):', new Date(this.startTime).toLocaleString());
                }
                
                // å¯åŠ¨å®šæ—¶æ›´æ–°
                this.startUptimeUpdater();
            },
            
            // å¯åŠ¨è¿è¡Œæ—¶é—´æ›´æ–°å™¨
            startUptimeUpdater() {
                if (this.uptimeTimer) {
                    clearInterval(this.uptimeTimer);
                }
                
                // ç«‹å³æ›´æ–°ä¸€æ¬¡
                this.updateUptime();
                
                // æ¯ç§’æ›´æ–°
                this.uptimeTimer = setInterval(() => {
                    this.updateUptime();
                }, 1000);
                
                console.log('â° åŠ¨æ€è¿è¡Œæ—¶é—´æ›´æ–°å™¨å·²å¯åŠ¨');
            },
            
            // æ›´æ–°è¿è¡Œæ—¶é—´æ˜¾ç¤º
            updateUptime() {
                const now = Date.now();
                const elapsed = now - this.startTime;
                const formattedTime = this.formatDuration(elapsed);
                
                const uptimeElement = document.getElementById('dynamic-uptime');
                if (uptimeElement) {
                    // æ·»åŠ åŠ¨æ€æ•°å­—è·³åŠ¨æ•ˆæœ
                    this.animateTimeUpdate(uptimeElement, formattedTime);
                }
            },
            
            // è¿è¡Œæ—¶é—´åŠ¨ç”»æ›´æ–°
            animateTimeUpdate(element, newTime) {
                const currentTime = element.textContent;
                
                // å¦‚æœæ—¶é—´æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡åŠ¨ç”»
                if (currentTime === newTime) return;
                
                // æ·»åŠ æ•°å­—è·³åŠ¨æ•ˆæœç±»
                element.style.transition = 'color 0.3s ease, text-shadow 0.3s ease';
                element.style.color = '#00e5ff';
                element.style.textShadow = '0 0 8px rgba(0, 229, 255, 0.6)';
                
                // æ›´æ–°æ–‡æœ¬
                element.textContent = newTime;
                
                // 300msåæ¢å¤æ­£å¸¸æ ·å¼
                setTimeout(() => {
                    element.style.color = '#00bcd4';
                    element.style.textShadow = 'none';
                }, 300);
            },
            
            // æ ¼å¼åŒ–æŒç»­æ—¶é—´
            formatDuration(ms) {
                const seconds = Math.floor(ms / 1000);
                const minutes = Math.floor(seconds / 60);
                const hours = Math.floor(minutes / 60);
                const days = Math.floor(hours / 24);
                
                if (days > 0) {
                    return `${days}å¤© ${hours % 24}æ—¶ ${minutes % 60}åˆ† ${seconds % 60}ç§’`;
                } else if (hours > 0) {
                    return `${hours}æ—¶ ${minutes % 60}åˆ† ${seconds % 60}ç§’`;
                } else if (minutes > 0) {
                    return `${minutes}åˆ† ${seconds % 60}ç§’`;
                } else {
                    return `${seconds}ç§’`;
                }
            },
            
            // é‡ç½®è¿è¡Œæ—¶é—´ï¼ˆå¼€å‘è€…åŠŸèƒ½ï¼‰
            reset() {
                this.startTime = Date.now() - this.baseOffsetMs;
                localStorage.setItem(this.storageKey, this.startTime.toString());
                this.updateUptime();
                console.log('ğŸ”„ è¿è¡Œæ—¶é—´å·²é‡ç½®åˆ°500å°æ—¶');
            },
            
            // åœæ­¢æ›´æ–°å™¨
            stop() {
                if (this.uptimeTimer) {
                    clearInterval(this.uptimeTimer);
                    this.uptimeTimer = null;
                    console.log('â¹ï¸ è¿è¡Œæ—¶é—´æ›´æ–°å™¨å·²åœæ­¢');
                }
            }
        };
        
        // ç«¯å£å·ç®¡ç†å™¨
        const PortManager = {
            currentPort: '{{ port }}', // åˆå§‹ç«¯å£å·
            portCheckTimer: null,
            
            // åˆå§‹åŒ–ç«¯å£æ£€æŸ¥
            init() {
                // ç«‹å³æ£€æŸ¥ä¸€æ¬¡çœŸå®ç«¯å£ï¼ˆè¦†ç›–æ¨¡æ¿ä¸­çš„ç¡¬ç¼–ç å€¼ï¼‰
                this.checkRealPort();
                this.updatePortDisplay();
                this.startPortChecker();
            },
            
            // å¯åŠ¨ç«¯å£æ£€æŸ¥å™¨
            startPortChecker() {
                // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡ç«¯å£å·
                this.portCheckTimer = setInterval(() => {
                    this.checkRealPort();
                }, 30000);
                
                console.log('ğŸ”Œ åŠ¨æ€ç«¯å£æ£€æŸ¥å™¨å·²å¯åŠ¨ (30ç§’é—´éš”)');
            },
            
            // æ£€æŸ¥çœŸå®ç«¯å£å·
            checkRealPort() {
                // é€šè¿‡å½“å‰URLè·å–ç«¯å£å·
                const url = new URL(window.location.href);
                let realPort = url.port;
                
                // å¦‚æœURLä¸­æ²¡æœ‰æ˜¾å¼æŒ‡å®šç«¯å£ï¼Œæ ¹æ®åè®®æ¨æ–­
                if (!realPort) {
                    realPort = url.protocol === 'https:' ? '443' : '80';
                }
                
                // è½¬æ¢ä¸ºå­—ç¬¦ä¸²è¿›è¡Œæ¯”è¾ƒ
                const realPortStr = String(realPort);
                const currentPortStr = String(this.currentPort);
                
                if (realPortStr !== currentPortStr) {
                    console.log(`ğŸ”Œ æ£€æµ‹åˆ°ç«¯å£å˜åŒ–: ${currentPortStr} â†’ ${realPortStr}`);
                    this.currentPort = realPortStr;
                    this.updatePortDisplay();
                }
            },
            
            // æ›´æ–°ç«¯å£æ˜¾ç¤º
            updatePortDisplay() {
                const portElement = document.getElementById('dynamic-port');
                if (portElement) {
                    // æ·»åŠ ç«¯å£å˜åŒ–åŠ¨ç”»æ•ˆæœ
                    this.animatePortUpdate(portElement, this.currentPort);
                }
            },
            
            // ç«¯å£å˜åŒ–åŠ¨ç”»
            animatePortUpdate(element, newPort) {
                const currentPort = element.textContent;
                
                // å¦‚æœç«¯å£æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡åŠ¨ç”»
                if (currentPort === newPort) return;
                
                // ç«¯å£å˜åŒ–æ—¶çš„é—ªçƒæ•ˆæœ
                element.style.transition = 'color 0.5s ease, text-shadow 0.5s ease';
                element.style.color = '#fce182';
                element.style.textShadow = '0 0 10px rgba(252, 225, 130, 0.8)';
                
                // æ›´æ–°æ–‡æœ¬
                element.textContent = newPort;
                
                // 500msåæ¢å¤æ­£å¸¸æ ·å¼
                setTimeout(() => {
                    element.style.color = '#00bcd4';
                    element.style.textShadow = 'none';
                }, 500);
                
                console.log(`ğŸ”Œ ç«¯å£æ˜¾ç¤ºå·²æ›´æ–°: ${newPort}`);
            },
            
            // åœæ­¢ç«¯å£æ£€æŸ¥å™¨
            stop() {
                if (this.portCheckTimer) {
                    clearInterval(this.portCheckTimer);
                    this.portCheckTimer = null;
                    console.log('â¹ï¸ ç«¯å£æ£€æŸ¥å™¨å·²åœæ­¢');
                }
            }
        };
        
        // é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨è¿è¡Œæ—¶é—´å’Œç«¯å£ç®¡ç†å™¨
        setTimeout(() => {
            RuntimeManager.init();
            PortManager.init();
            console.log('âœ… åŠ¨æ€æ—¶é—´å’Œç«¯å£ç³»ç»Ÿå·²å¯åŠ¨');
        }, 1000);
        
        // æš´éœ²åˆ°å…¨å±€ï¼ˆä¾›å¼€å‘è€…æ§åˆ¶å°ä½¿ç”¨ï¼‰
        window.RuntimeManager = RuntimeManager;
        window.PortManager = PortManager;
        
        // å¼€å‘è€…è°ƒè¯•åŠŸèƒ½
        window.debugPort = function() {
            console.log('ğŸ” ç«¯å£è°ƒè¯•ä¿¡æ¯:');
            console.log('  å½“å‰æ˜¾ç¤ºç«¯å£:', PortManager.currentPort);
            console.log('  URLç«¯å£:', new URL(window.location.href).port || 'é»˜è®¤ç«¯å£');
            console.log('  å®Œæ•´URL:', window.location.href);
            PortManager.checkRealPort();
        };
        
    </script>
</body>
</html>