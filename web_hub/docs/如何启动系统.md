# 🚀 集群视频处理系统启动指南

## 📋 系统架构

本系统采用集群架构，包含两种节点：
- **监控节点**：监控论坛，发现新帖子并分发任务
- **工作节点**：接收任务，执行视频处理

### 第0步：准备 .env（项目根目录）

- 复制根目录示例为实际配置：`.env.example` → `.env`
- 在项目根目录设置论坛账号（不要提交到仓库）；论坛地址仍在 `config/forum_settings.yaml`

```ini
# 复制示例
# cp .env.example .env

# 设置论坛账号（不要提交到仓库）
FORUM_USERNAME=
FORUM_PASSWORD=
# 兼容变量（可选）
# AICUT_ADMIN_USERNAME=
# AICUT_ADMIN_PASSWORD=

# 开发环境模拟数据（生产请保持 false）
ENABLE_MOCK_DATA=false
```

## 🚀 快速启动

### 第1步：启动监控节点

```bash
# 从仓库根目录启动（推荐）
python web_hub/cluster_monitor/start_unified.py --mode production --port 8000

# 或使用批处理（Windows）
1-启动监控节点.bat
```

### 第2步：启动工作节点

在每台处理机器上运行：

```bash
# 从仓库根目录启动（推荐）
python web_hub/start_lightweight.py --port 8005

# 或使用批处理（Windows）
2-启动工作节点.bat

# 多台机器示例
python web_hub/start_lightweight.py --port 8006  # 机器2
python web_hub/start_lightweight.py --port 8007  # 机器3
```

### 第3步：配置机器列表

编辑 `cluster_monitor/machines.txt`：

```
# 处理机器列表 (格式: IP地址:端口:优先级)
localhost:8005:1    # 本地高性能GPU机器
localhost:8006:2    # 本地普通处理机器
192.168.1.100:8005:1    # 远程GPU机器
192.168.1.101:8005:2    # 远程普通机器
```

## 🎯 集群特性

### 负载均衡策略
- ✅ **优先选择空闲机器**：自动检测机器忙碌状态
- ✅ **按优先级分发**：高性能机器优先处理
- ✅ **任务数量均衡**：都在忙时选择任务最少的
- ✅ **故障自动跳过**：离线机器自动排除

### 监控界面
访问监控节点：`http://localhost:8000`

功能：
- 🖥️ **实时机器状态**：在线/离线、忙碌/空闲
- 📋 **任务分发统计**：成功率、失败率
- 🎯 **负载均衡状态**：任务分布情况
- ⚙️ **集群管理**：启动/停止监控、检查机器

## 🔧 配置要求

### 网络要求
- 监控机器能访问所有处理机器
- 处理机器提供HTTP接口
- 建议使用内网部署，确保网络稳定

### 机器配置建议
- **监控机器**：普通配置即可，主要负责任务分发
- **处理机器**：GPU机器，负责视频处理
- **存储**：每台机器至少10GB可用空间

## ✅ 启动成功标志

### 监控节点日志：
```
🚀 使用Waitress启动集群监控系统
📊 端口: 8000
🌐 访问地址: http://localhost:8000
📋 成功加载 2 台处理机器:
   - http://localhost:8005 (优先级: 1)
   - http://localhost:8006 (优先级: 2)
✅ 论坛登录成功
🔍 论坛监控已启动
```

### 工作节点日志：
```
🚀 启动集群视频处理系统 - 🔗 集群工作节点...
🔗 工作节点：启用论坛解析，等待任务分配，端口: 8005
✅ 集群API端点已添加到Web服务器
✅ 系统启动成功！
🌐 Web监控界面: http://localhost:8005
🔗 任务接收端点: http://localhost:8005/api/worker/receive-task
```

## 🧪 集群功能测试

### 测试监控节点
```bash
# 启动论坛监控
curl -X POST http://localhost:8000/api/start-monitoring

# 检查机器状态
curl http://localhost:8000/api/machines/status

# 查看集群状态
curl http://localhost:8000/api/cluster/status
```

### 测试工作节点
```bash
# 测试工作节点状态
curl http://localhost:8005/api/worker/status

# 测试任务接收端点
curl -X POST -H "Content-Type: application/json" \
  -d '{"url":"https://tts.lrtcai.com/forum.php?mod=viewthread&tid=121"}' \
  http://localhost:8005/api/worker/receive-task
```

### 快速验证环境（不启动服务）

```bash
python web_hub/cluster_monitor/start_unified.py --check-only
```

## 🔧 启动前检查

### 环境确认
```bash
# 确认Python环境
python --version
# 应显示: Python 3.10+

# 确认虚拟环境激活
# 命令行应显示: (zhibocut)
```

### 依赖检查
```bash
# 检查核心依赖
python -c "import redis, psutil, yaml, flask, waitress; print('✅ 依赖包正常')"
```

### Redis服务检查（必需）
```bash
# 启动Redis服务
redis-server

# 验证Redis连接
redis-cli ping
# 应返回: PONG
```

### GPU状态检查（推荐）
```bash
# 检查GPU状态
nvidia-smi
# 确认CUDA支持和h264_nvenc可用
```

## ⚡ 故障排除

### 监控节点连接失败
**现象**: 监控界面显示机器离线
**解决**:
```bash
# 检查网络连接
ping localhost

# 检查端口是否开放
telnet localhost 8005

# 检查防火墙设置
```

### 任务分发失败
**现象**: 发现新帖但没有分发任务
**解决**:
```bash
# 检查机器配置文件
cat cluster_monitor/machines.txt

# 手动检查机器状态
curl http://localhost:8005/api/worker/status

# 设置/检查根目录 .env 中的论坛凭证（不要放到 YAML）
# FORUM_USERNAME=...
# FORUM_PASSWORD=...
# 论坛地址在 config/forum_settings.yaml 中配置

# 测试任务接收端点
curl -X POST -H "Content-Type: application/json" \
  -d '{"url":"https://tts.lrtcai.com/forum.php?mod=viewthread&tid=121"}' \
  http://localhost:8005/api/worker/receive-task
```

### 机器配置错误
**现象**: 机器列表加载失败
**解决**:
```bash
# 检查配置文件格式 (IP:端口:优先级)
# 示例: localhost:8005:1
notepad cluster_monitor/machines.txt
```

## 🛑 停止系统

在运行终端中按 `Ctrl+C`：
```
🛑 接收到停止信号...
✅ 系统已安全关闭
```

## 🚀 启动成功后

### 1. 检查Web界面
- 访问 http://localhost:8000
- 确认系统状态正常
- 查看机器状态

### 2. 启动论坛监控
```bash
curl -X POST http://localhost:8000/api/start-monitoring
```

### 3. 观察处理过程
- 系统会显示详细的处理步骤
- 包括下载、AI处理、剪辑、上传等
- 整个过程完全自动化

## 📋 部署检查清单

### 监控节点检查 ✅
- [ ] cluster_monitor目录文件完整
- [ ] machines.txt配置正确
- [ ] 端口8000未被占用
- [ ] Web界面显示所有机器状态

### 工作节点检查 ✅
- [ ] Python环境正常
- [ ] start_lightweight.py启动成功
- [ ] 端口未被占用
- [ ] 显示"� 集群工作节点"
- [ ] GPU驱动正常 (如果使用GPU)

### 集群连接验证 ✅
- [ ] 监控节点能检测到所有工作节点
- [ ] 机器状态显示"在线"
- [ ] 任务分发测试成功
- [ ] 负载均衡正常工作

## 📋 集群模式命令

### 监控节点（cluster_monitor目录）
```bash
# 进入监控系统目录
cd d:\funclip-xiaocut-cut6.0\cluster_monitor

# 启动集群监控节点
python start_unified.py --mode production --port 8000
```

### 工作节点（主目录）
```bash
# 进入主目录
cd d:\funclip-xiaocut-cut6.0

# 启动集群工作节点
python start_lightweight.py --port 8005
python start_lightweight.py --port 8006  # 第二台机器
python start_lightweight.py --port 8007  # 第三台机器

# 测试模式
python start_lightweight.py --test --port 8005
```

**说明**：
- 监控节点：负责监控论坛，发现新帖并分发任务
- 工作节点：接收任务，执行视频处理（默认worker模式）
- 不支持其他模式，专注集群架构

---

**最后更新**: 2025-07-04
**系统版本**: v6.0 (纯集群模式版)

🎉 **集群系统已准备好为您提供24/7自动化视频处理服务！** 🚀
