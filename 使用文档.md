# TTS论坛集成系统 - 使用文档

**版本**: 2.1.0
**更新时间**: 2025-11-04
**适用环境**: Windows 10/11, Python 3.10+

---

## 📋 目录

1. [系统简介](#系统简介)
2. [快速开始](#快速开始)
3. [环境配置](#环境配置)
4. [启动系统](#启动系统)
5. [使用指南](#使用指南)
6. [配置说明](#配置说明)
7. [常见问题](#常见问题)
8. [API接口](#api接口)
9. [故障排查](#故障排查)

---

## 系统简介

### 功能概述

TTS论坛集成系统是一个自动化的语音合成服务平台，用户可以通过论坛发帖的方式：

1. **音色克隆** - 上传音频样本，克隆自己的声音
2. **AI语音生成** - 使用已有音色生成AI语音

系统会自动监控论坛帖子，处理请求，生成音频，并回复到论坛。

### 核心特性

- ✅ **自动监控** - 实时监控论坛新帖
- ✅ **智能识别** - 99%准确率识别用户请求
- ✅ **权限管理** - 公共/私有音色权限控制
- ✅ **配额管理** - 音色数量和存储空间限制
- ✅ **Web监控** - 实时查看系统状态和任务进度

### 系统架构

```
论坛发帖 → 监控节点 → 请求解析 → 权限验证 → TTS处理 → 论坛回复
```

---

## 快速开始

### 前置要求

1. **Python环境**: `D:\index-tts-2-6G-0914\index-tts-2\tts\indextts2\py312\python.exe`
2. **Redis服务**: 用于任务队列管理（工作节点必需）
3. **网络连接**: 访问论坛 `https://tts.lrtcai.com`
4. **Waitress**: 生产级WSGI服务器（推荐，已预装）

### 一键启动 ⭐

**推荐方式（完整系统）**：
```bash
# 双击运行
启动完整系统.bat
```

**功能**：
- ✅ 自动启动监控节点 + 工作节点
- ✅ 完整的环境检查
- ✅ 自动打开Web界面
- ✅ 使用生产级服务器（Waitress）

**单独启动监控节点**：
```bash
# 双击运行
启动监控节点.bat
```

**单独启动工作节点**：
```bash
# 双击运行
启动工作节点.bat
```

**命令行启动**：
```bash
# 监控节点
"tts/indextts2/py312/python.exe" web_hub/cluster_monitor/start_unified.py --mode production --port 8000

# 工作节点
"tts/indextts2/py312/python.exe" web_hub/start_lightweight.py --port 8005
```

启动成功后，访问：
- 监控节点：`http://localhost:8000`
- 工作节点：`http://localhost:8005`

---

## 环境配置

### 1. 配置论坛账号

编辑 `web_hub/.env` 文件（如不存在则创建）：

```bash
# 论坛账号配置
FORUM_USERNAME=AI剪辑助手
FORUM_PASSWORD=你的论坛密码

# 系统配置
TASK_DISPATCH_MODE=lightweight
FORUM_TEST_MODE=false
```

### 2. 配置论坛设置

编辑 `config/forum_settings.yaml`：

```yaml
forum:
  base_url: https://tts.lrtcai.com
  target_url: https://tts.lrtcai.com/forum-2-1.html
  forum_id: 2
  check_interval: 10  # 检查间隔（秒）

credentials:
  username: AI剪辑助手
  password: ${FORUM_PASSWORD}  # 从环境变量读取
```

### 3. 数据库初始化

系统首次启动会自动初始化数据库：

```bash
"tts/indextts2/py312/python.exe" tts/custom_integration/integration/tts_init_db.py
```

数据库位置：`tts/custom_integration/integration/database/tts_voice_system.db`

---

## 启动系统

### 方式1：使用启动脚本（推荐）⭐

#### 启动完整系统（一键启动）

```bash
启动完整系统.bat
```

**功能**：
- ✅ 自动启动监控节点（端口8000）
- ✅ 自动启动工作节点（端口8005）
- ✅ 完整的环境检查
- ✅ 自动打开Web界面
- ✅ 使用生产级服务器（Waitress）

#### 单独启动监控节点

```bash
启动监控节点.bat
```

**功能**：
- ✅ 检查Python环境
- ✅ 检查并初始化数据库
- ✅ 检查Redis连接
- ✅ 启动监控节点（端口8000）
- ✅ 使用生产级服务器（Waitress/Gunicorn）

#### 单独启动工作节点

```bash
启动工作节点.bat
```

**功能**：
- ✅ 检查Python环境
- ✅ 检查Waitress是否安装
- ✅ 检查Redis连接（必需）
- ✅ 检查监控节点状态
- ✅ 启动工作节点（端口8005）
- ✅ 使用生产级服务器（Waitress）

### 方式2：手动启动

#### 启动监控节点

```bash
cd web_hub/cluster_monitor
"../../tts/indextts2/py312/python.exe" start_unified.py --mode production --port 8000
```

**说明**：
- 生产模式自动使用Waitress（Windows）或Gunicorn（Linux）
- 无开发服务器警告信息

#### 启动工作节点

```bash
"tts/indextts2/py312/python.exe" web_hub/start_lightweight.py --port 8005
```

**说明**：
- 自动检测并使用Waitress生产服务器
- 如果Waitress未安装，自动回退到Flask开发服务器

### 生产级服务器说明 🚀

系统已升级使用生产级WSGI服务器：

**监控节点**：
- Windows: Waitress
- Linux: Gunicorn

**工作节点**：
- Windows: Waitress（推荐）
- Linux: Waitress（推荐）

**优势**：
- ✅ 多线程并发处理（4线程）
- ✅ 高性能、高稳定性
- ✅ 无开发服务器警告
- ✅ 适合生产环境

**依赖检查**：
```bash
# 检查Waitress是否安装
"tts/indextts2/py312/python.exe" -c "import waitress; print(waitress.__version__)"

# 如果未安装（可选，系统会自动回退）
"tts/indextts2/py312/python.exe" -m pip install waitress
```

### 验证启动

访问 `http://localhost:8000`（监控节点）或 `http://localhost:8005`（工作节点），应该看到：

**监控节点**：
- 🟢 **系统状态**: 在线
- 🟢 **Redis连接**: 正常
- 🟢 **数据库**: 正常
- 🟢 **论坛监控**: 运行中
- 🚀 **服务器**: Waitress生产服务器

**工作节点**：
- 🟢 **系统状态**: 在线
- 🟢 **任务队列**: 正常
- 🟢 **资源监控**: 正常
- 🚀 **服务器**: Waitress生产服务器

---

## 使用指南

### 论坛帖子格式（兼容）

系统解析器已兼容以下三种标记格式：
- 方括号参数：[音色克隆]、[文案]、[选择音色]
- 中文书名号参数：【音色克隆】、【文案】、【选择音色】
- 冒号+换行参数：音色名称:\n张三、选择音色:\n本人音色

实际论坛常见示例：

音色克隆（实际格式）
```
音色克隆
音色名称:
张盼盼
（附件）盼盼.WAV
```

TTS 生成（实际格式）
```
制作AI声音
选择音色:
本人音色
你好 这是测试
```


### 用户操作流程

#### 1. 音色克隆

在论坛发帖：

**标题**：
```
【音色克隆】我的声音克隆
```

**内容**：
```
【音色名称】我的专属音色
【是否公开】否
```

**附件**：上传一个音频文件（WAV/MP3格式，建议10-30秒）

**系统处理**：
1. 监控到新帖
2. 下载音频文件
3. 训练音色模型
4. 保存到数据库
5. 回复处理结果

#### 2. AI语音生成

在论坛发帖：

**标题**：
```
【制作AI声音】生成语音
```

**内容**：
```
【文案】大家好，欢迎来到我的频道！今天我们来聊聊人工智能。
【选择音色】我的专属音色
【语速】1.0
【音调】1.0
```

**系统处理**：
1. 监控到新帖
2. 验证音色权限
3. 生成AI语音
4. 上传音频文件
5. 回复下载链接

### 音色选择规则

- 选择音色为“本人音色”或未指定时：使用该用户的默认音色（最近一次克隆成功的音色）
- 指定具体音色名称：优先匹配该用户克隆的同名音色；若无则匹配系统预置音色
- 用户隔离：不同用户的“本人音色”互相独立，互不影响
- 无默认音色：回退到系统默认音色（如“苏瑶”）
- 数据存储：本地 SQLite 数据库 tts/custom_integration/integration/database/tts_voice_system.db；克隆成功后自动保存并设为默认

### 管理员操作

#### 查看系统状态

访问 `http://localhost:8000`，可以看到：

- **系统概览** - CPU、内存、磁盘使用率
- **任务列表** - 当前处理中的任务
- **用户统计** - 用户数量、音色数量
- **日志查看** - 实时系统日志

#### 管理用户配额

编辑数据库或使用API：

```python
# 修改用户配额
UPDATE users
SET voice_quota = 50, storage_quota_mb = 1000
WHERE user_id = 'forum_12345';
```

#### 管理公共音色

```python
# 设置音色为公共
UPDATE voices
SET is_public = 1
WHERE voice_id = 'voice_id_here';
```

---

## 配置说明

### 论坛配置 (`config/forum_settings.yaml`)

```yaml
forum:
  base_url: https://tts.lrtcai.com        # 论坛基础URL
  target_url: https://tts.lrtcai.com/forum-2-1.html  # 监控板块
  forum_id: 2                              # 板块ID
  check_interval: 10                       # 检查间隔（秒）
  max_retries: 3                          # 最大重试次数
  timeout: 30                             # 请求超时（秒）

credentials:
  username: AI剪辑助手                     # 论坛账号
  password: ${FORUM_PASSWORD}             # 从环境变量读取

processing:
  max_concurrent_tasks: 5                 # 最大并发任务数
  task_timeout: 300                       # 任务超时（秒）
```

### 用户配额配置

默认配额（在 `tts_init_db.py` 中定义）：

```python
voice_quota = 20           # 每个用户最多20个音色
storage_quota_mb = 500     # 每个用户最多500MB存储空间
```

### 日志配置

日志文件位置：
- `logs/forum_monitor.log` - 论坛监控日志
- `logs/tts_forum_monitor.log` - TTS处理日志
- `logs/error.log` - 错误日志
- `logs/lightweight.log` - 工作节点日志

---

## 常见问题

### Q1: 启动后无法访问Web界面？

**解决方案**：
1. 检查端口是否被占用：`netstat -ano | findstr 8000`
2. 检查防火墙设置
3. 尝试使用其他端口：`--port 8001`

### Q2: 论坛监控不工作？

**解决方案**：
1. 检查论坛账号密码是否正确
2. 检查网络连接：`ping tts.lrtcai.com`
3. 查看日志：`logs/forum_monitor.log`
4. 检查Redis是否运行：`redis-cli ping`

### Q3: 用户无法使用某个音色？

**解决方案**：
1. 检查音色是否为公共音色
2. 检查用户是否为音色所有者
3. 查看权限日志确认拒绝原因

### Q4: 数据库错误？

**解决方案**：
```bash
# 重新初始化数据库
"tts/indextts2/py312/python.exe" tts/custom_integration/integration/tts_init_db.py
```

### Q5: 如何停止系统？

**解决方案**：
- 在启动窗口按 `Ctrl+C`
- 或关闭命令行窗口

### Q6: 看到"WARNING: This is a development server"警告？

**说明**：这不是错误！这是Flask的警告信息。

**解决方案**：
系统已升级使用Waitress生产服务器，不会再显示此警告。

如果仍然看到警告：
```bash
# 1. 检查Waitress是否安装
"tts/indextts2/py312/python.exe" -c "import waitress; print(waitress.__version__)"

# 2. 如果未安装，安装Waitress
"tts/indextts2/py312/python.exe" -m pip install waitress

# 3. 重新启动系统
启动工作节点.bat
```

**预期输出**（Waitress已安装）：
```
🚀 使用Waitress生产服务器
INFO:waitress:Serving on http://0.0.0.0:8005
✅ 系统启动成功！
```

**性能提升**：
- ✅ 多线程并发处理（4线程）
- ✅ 更高的性能和稳定性
- ✅ 适合生产环境
- ✅ 无警告信息

---

## API接口

### 系统状态

```http
GET http://localhost:8000/api/status
```

**响应**：
```json
{
  "status": "online",
  "redis": "connected",
  "database": "connected",
  "forum_monitor": "running"
}
```

### 任务列表

```http
GET http://localhost:8000/api/tasks
```

**响应**：
```json
{
  "tasks": [
    {
      "task_id": "task_123",
      "type": "voice_clone",
      "status": "processing",
      "user_id": "forum_12345"
    }
  ]
}
```

### 用户信息

```http
GET http://localhost:8000/api/users/{user_id}
```

**响应**：
```json
{
  "user_id": "forum_12345",
  "username": "张三",
  "voice_quota": 20,
  "storage_quota_mb": 500,
  "voices_count": 3,
  "storage_used_mb": 45.6
}
```

---

## 故障排查

### 日志查看

```bash
# 查看最新日志
tail -f logs/forum_monitor.log

# 查看错误日志
tail -f logs/error.log

# 搜索特定错误
grep "ERROR" logs/*.log
```

### 数据库检查

```bash
# 进入数据库
sqlite3 tts/custom_integration/integration/database/tts_voice_system.db

# 查看用户
SELECT * FROM users;

# 查看音色
SELECT * FROM voices;

# 退出
.quit
```

### Redis检查

```bash
# 检查Redis连接
redis-cli ping

# 查看队列
redis-cli LLEN task_queue

# 查看所有键
redis-cli KEYS *
```

### 系统重启

```bash
# 1. 停止所有服务
Ctrl+C

# 2. 清理Redis（可选）
redis-cli FLUSHALL

# 3. 重新启动
启动完整系统.bat
```

---

## 附录

### 目录结构

```
index-tts-2/
├── config/                    # 配置文件
│   └── forum_settings.yaml
├── tts/                       # TTS相关
│   └── custom_integration/
│       └── integration/
│           ├── tts_forum_processor.py    # 核心处理器
│           ├── tts_forum_sync.py         # 用户同步
│           ├── tts_permission_manager.py # 权限管理
│           └── database/
│               └── tts_voice_system.db   # 数据库
├── web_hub/                   # Web集群系统
│   ├── cluster_monitor/       # 监控节点
│   │   ├── start_unified.py
│   │   └── forum_monitor.py
│   └── lightweight/           # 工作节点
│       └── web_server.py      # Web服务器（使用Waitress）
├── logs/                      # 日志文件
├── 启动完整系统.bat           # 一键启动脚本（推荐）
├── 启动监控节点.bat           # 监控节点启动脚本
└── 启动工作节点.bat           # 工作节点启动脚本
```

### 相关文档

- `使用文档.md` - 本文档，系统使用指南
- `Waitress生产服务器升级说明.md` - Waitress升级详解
- `docs/方案B-TTS统一整合架构方案.md` - 系统架构设计
- `web_hub/docs/如何启动系统.md` - 启动指南

### 技术栈

**核心技术**：
- Python 3.10.18
- Flask - Web框架
- Waitress - 生产级WSGI服务器（Windows）
- Redis - 任务队列
- SQLite - 数据存储

**生产级服务器**：
- 监控节点：Waitress（Windows）/ Gunicorn（Linux）
- 工作节点：Waitress（跨平台）

### 技术支持

- **GitHub**: https://github.com/beyondchenlin/web_hub
- **论坛**: https://tts.lrtcai.com
- **邮箱**: beyondchenlin@users.noreply.github.com

---

**最后更新**: 2025-11-04
**文档版本**: 2.1.0 - 新增“本人音色”映射与论坛冒号+换行格式兼容

