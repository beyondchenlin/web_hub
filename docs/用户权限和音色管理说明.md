# ç”¨æˆ·æƒé™å’ŒéŸ³è‰²ç®¡ç†æœºåˆ¶è¯´æ˜

## ğŸ“‹ é—®é¢˜å›ç­”

### é—®é¢˜1ï¼šå¦‚ä½•é˜²æ­¢ç”¨æˆ·éŸ³è‰²å¯¹åº”å‡ºé”™ï¼Ÿ

**è§£å†³æ–¹æ¡ˆï¼šé€šè¿‡æ•°æ®åº“å…³è”ç¡®ä¿ä¸€ä¸€å¯¹åº”**

#### 1.1 ç”¨æˆ·IDæ˜ å°„æœºåˆ¶

```
è®ºå›ç³»ç»Ÿ                    TTSç³»ç»Ÿ
-----------                -----------
ç”¨æˆ·ID: 12345    ------>   ç”¨æˆ·ID: forum_12345
ç”¨æˆ·å: å¼ ä¸‰               ç”¨æˆ·å: å¼ ä¸‰
                           é…é¢: 20ä¸ªéŸ³è‰², 500MB
```

**å…³é”®ä»£ç **ï¼š
```python
# tts_forum_sync.py
def sync_forum_user(self, forum_user_id: str, forum_username: str):
    # ç”ŸæˆTTSç³»ç»Ÿç”¨æˆ·ID
    tts_user_id = f"forum_{forum_user_id}"
    
    # ä¿å­˜åˆ°æ•°æ®åº“
    INSERT INTO users (
        user_id,           # forum_12345
        username,          # å¼ ä¸‰
        forum_user_id,     # 12345 (åŸå§‹è®ºå›ID)
        forum_username,    # å¼ ä¸‰
        voice_quota,       # 20
        storage_quota_mb   # 500
    )
```

#### 1.2 éŸ³è‰²æ‰€æœ‰æƒæœºåˆ¶

```
éŸ³è‰²è¡¨ (voices)
--------------
voice_id: user_12345_voice_001
voice_name: å¼ ä¸‰çš„å£°éŸ³
owner_id: forum_12345  â† å…³é”®ï¼è¿™ä¸ªå­—æ®µç¡®ä¿éŸ³è‰²å±äºç‰¹å®šç”¨æˆ·
is_public: 0           â† 0=ç§æœ‰ï¼Œ1=å…¬å…±
file_path: /path/to/model.pt
```

**å·¥ä½œæµç¨‹**ï¼š
```
1. ç”¨æˆ·12345åœ¨è®ºå›å‘å¸–ã€éŸ³è‰²å…‹éš†ã€‘
   â†“
2. ç³»ç»Ÿè¯†åˆ«ç”¨æˆ·ID: 12345
   â†“
3. è½¬æ¢ä¸ºTTSç”¨æˆ·ID: forum_12345
   â†“
4. å…‹éš†éŸ³è‰²åä¿å­˜ï¼š
   - voice_id: user_12345_voice_001
   - owner_id: forum_12345  â† ç»‘å®šåˆ°ç”¨æˆ·
   â†“
5. ä¸‹æ¬¡ç”¨æˆ·12345å‘å¸–ã€åˆ¶ä½œAIå£°éŸ³ã€‘
   â†“
6. ç³»ç»ŸæŸ¥è¯¢ï¼š
   SELECT * FROM voices 
   WHERE owner_id = 'forum_12345' 
   OR is_public = 1
   â†“
7. è¿”å›ç”¨æˆ·å¯ç”¨çš„éŸ³è‰²åˆ—è¡¨
```

#### 1.3 é˜²æ­¢å‡ºé”™çš„ä¸‰é‡ä¿éšœ

**ä¿éšœ1ï¼šæ•°æ®åº“å¤–é”®çº¦æŸ**
```sql
CREATE TABLE voices (
    voice_id VARCHAR(50) PRIMARY KEY,
    owner_id VARCHAR(50),
    FOREIGN KEY (owner_id) REFERENCES users(user_id) ON DELETE CASCADE
)
```
- å¦‚æœç”¨æˆ·è¢«åˆ é™¤ï¼Œå…¶éŸ³è‰²è‡ªåŠ¨åˆ é™¤
- æ— æ³•åˆ›å»ºæ²¡æœ‰æ‰€æœ‰è€…çš„éŸ³è‰²

**ä¿éšœ2ï¼šå”¯ä¸€æ€§çº¦æŸ**
```sql
CREATE INDEX idx_voices_owner ON voices(owner_id)
CREATE INDEX idx_users_forum_id ON users(forum_user_id)
```
- å¿«é€ŸæŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰éŸ³è‰²
- é˜²æ­¢é‡å¤åˆ›å»º

**ä¿éšœ3ï¼šæƒé™éªŒè¯**
```python
# tts_permission_manager.py
def can_use_voice_by_name(self, user_id: str, voice_name: str):
    # æŸ¥è¯¢éŸ³è‰²
    SELECT voice_id, owner_id, is_public 
    FROM voices 
    WHERE voice_name = ?
    
    # è§„åˆ™1ï¼šå…¬å…±éŸ³è‰² â†’ æ‰€æœ‰äººå¯ç”¨
    if is_public == 1:
        return True
    
    # è§„åˆ™2ï¼šç§æœ‰éŸ³è‰² â†’ ä»…æ‰€æœ‰è€…å¯ç”¨
    if owner_id == user_id:
        return True
    
    # è§„åˆ™3ï¼šå…¶ä»–æƒ…å†µ â†’ æ‹’ç»
    return False
```

---

### é—®é¢˜2ï¼šå¦‚ä½•æœ¬åœ°å¯¹åº”ï¼Œé˜²æ­¢å‡ºé”™ï¼Ÿ

**è§£å†³æ–¹æ¡ˆï¼šæœ¬åœ°æ•°æ®åº“ + å®æ—¶åŒæ­¥**

#### 2.1 æœ¬åœ°æ•°æ®åº“è®¾è®¡

```
TTSç³»ç»Ÿæ•°æ®åº“ (tts_voice_system.db)
â”œâ”€â”€ usersè¡¨          - ç”¨æˆ·ä¿¡æ¯
â”‚   â”œâ”€â”€ user_id      - TTSç³»ç»ŸID (forum_12345)
â”‚   â”œâ”€â”€ forum_user_id - è®ºå›åŸå§‹ID (12345)
â”‚   â”œâ”€â”€ username     - ç”¨æˆ·å
â”‚   â””â”€â”€ voice_quota  - é…é¢
â”‚
â”œâ”€â”€ voicesè¡¨         - éŸ³è‰²åº“
â”‚   â”œâ”€â”€ voice_id     - éŸ³è‰²ID
â”‚   â”œâ”€â”€ voice_name   - éŸ³è‰²åç§°
â”‚   â”œâ”€â”€ owner_id     - æ‰€æœ‰è€…ID (forum_12345)
â”‚   â”œâ”€â”€ is_public    - æ˜¯å¦å…¬å…±
â”‚   â””â”€â”€ file_path    - æ¨¡å‹æ–‡ä»¶è·¯å¾„
â”‚
â””â”€â”€ generation_historyè¡¨ - ç”Ÿæˆå†å²
    â”œâ”€â”€ user_id      - è°ç”Ÿæˆçš„
    â”œâ”€â”€ voice_id     - ä½¿ç”¨å“ªä¸ªéŸ³è‰²
    â””â”€â”€ created_at   - ç”Ÿæˆæ—¶é—´
```

#### 2.2 å®æ—¶åŒæ­¥æœºåˆ¶

```python
# æ¯æ¬¡å¤„ç†è®ºå›å¸–å­æ—¶è‡ªåŠ¨åŒæ­¥
def process_forum_post(self, post_data):
    # ç¬¬1æ­¥ï¼šåŒæ­¥ç”¨æˆ·
    author_id = post_data['author_id']  # 12345
    author_name = post_data['author_name']  # å¼ ä¸‰
    
    # è‡ªåŠ¨åŒæ­¥åˆ°æœ¬åœ°æ•°æ®åº“
    self.user_sync.sync_forum_user(author_id, author_name)
    # ç»“æœï¼š
    # - å¦‚æœç”¨æˆ·ä¸å­˜åœ¨ â†’ åˆ›å»ºæ–°ç”¨æˆ·
    # - å¦‚æœç”¨æˆ·å·²å­˜åœ¨ â†’ æ›´æ–°æœ€åç™»å½•æ—¶é—´
    
    # ç¬¬2æ­¥ï¼šå¤„ç†è¯·æ±‚
    tts_user_id = f"forum_{author_id}"  # forum_12345
    
    # ç¬¬3æ­¥ï¼šéªŒè¯æƒé™
    can_use = self.permission_manager.can_use_voice(
        user_id=tts_user_id,
        voice_name="å¼ ä¸‰çš„å£°éŸ³"
    )
```

#### 2.3 æ•°æ®ä¸€è‡´æ€§ä¿è¯

**åœºæ™¯1ï¼šç”¨æˆ·é¦–æ¬¡ä½¿ç”¨**
```
1. ç”¨æˆ·12345åœ¨è®ºå›å‘å¸–
   â†“
2. ç³»ç»Ÿæ£€æµ‹åˆ°æ–°ç”¨æˆ·
   â†“
3. è‡ªåŠ¨åˆ›å»ºæœ¬åœ°ç”¨æˆ·è®°å½•ï¼š
   INSERT INTO users (
       user_id='forum_12345',
       forum_user_id='12345',
       username='å¼ ä¸‰',
       voice_quota=20,
       storage_quota_mb=500
   )
   â†“
4. ç”¨æˆ·å¯ä»¥ç«‹å³ä½¿ç”¨ç³»ç»Ÿ
```

**åœºæ™¯2ï¼šç”¨æˆ·å…‹éš†éŸ³è‰²**
```
1. ç”¨æˆ·12345å‘å¸–ã€éŸ³è‰²å…‹éš†ã€‘
   â†“
2. ç³»ç»Ÿä¸‹è½½éŸ³é¢‘å¹¶è®­ç»ƒæ¨¡å‹
   â†“
3. ä¿å­˜éŸ³è‰²åˆ°æœ¬åœ°ï¼š
   INSERT INTO voices (
       voice_id='user_12345_voice_001',
       voice_name='å¼ ä¸‰çš„å£°éŸ³',
       owner_id='forum_12345',  â† ç»‘å®šåˆ°ç”¨æˆ·
       is_public=0,
       file_path='/path/to/model.pt'
   )
   â†“
4. ä¸‹æ¬¡ç”¨æˆ·12345å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªéŸ³è‰²
```

**åœºæ™¯3ï¼šç”¨æˆ·ä½¿ç”¨éŸ³è‰²**
```
1. ç”¨æˆ·12345å‘å¸–ã€åˆ¶ä½œAIå£°éŸ³ã€‘
   â†“
2. è¯·æ±‚ä½¿ç”¨"å¼ ä¸‰çš„å£°éŸ³"
   â†“
3. ç³»ç»ŸæŸ¥è¯¢ï¼š
   SELECT * FROM voices 
   WHERE voice_name='å¼ ä¸‰çš„å£°éŸ³'
   AND (owner_id='forum_12345' OR is_public=1)
   â†“
4. æ‰¾åˆ°éŸ³è‰² â†’ ç”ŸæˆéŸ³é¢‘
   æ‰¾ä¸åˆ° â†’ è¿”å›é”™è¯¯
```

---

## ğŸ” å®Œæ•´çš„æƒé™éªŒè¯æµç¨‹

### æµç¨‹å›¾

```
ç”¨æˆ·å‘å¸–
  â†“
æå–ç”¨æˆ·ID (12345)
  â†“
è½¬æ¢ä¸ºTTSç”¨æˆ·ID (forum_12345)
  â†“
åŒæ­¥ç”¨æˆ·åˆ°æœ¬åœ°æ•°æ®åº“
  â”œâ”€ ç”¨æˆ·ä¸å­˜åœ¨ â†’ åˆ›å»ºæ–°ç”¨æˆ·
  â””â”€ ç”¨æˆ·å·²å­˜åœ¨ â†’ æ›´æ–°ä¿¡æ¯
  â†“
è§£æè¯·æ±‚ç±»å‹
  â”œâ”€ TTSè¯·æ±‚
  â”‚   â†“
  â”‚   æå–éŸ³è‰²åç§°
  â”‚   â†“
  â”‚   æŸ¥è¯¢éŸ³è‰²ï¼š
  â”‚   SELECT * FROM voices WHERE voice_name=?
  â”‚   â†“
  â”‚   æƒé™éªŒè¯ï¼š
  â”‚   â”œâ”€ is_public=1 â†’ âœ… å…è®¸
  â”‚   â”œâ”€ owner_id=forum_12345 â†’ âœ… å…è®¸
  â”‚   â””â”€ å…¶ä»– â†’ âŒ æ‹’ç»
  â”‚
  â””â”€ éŸ³è‰²å…‹éš†è¯·æ±‚
      â†“
      é…é¢éªŒè¯ï¼š
      â”œâ”€ éŸ³è‰²æ•°é‡ < voice_quota â†’ âœ… ç»§ç»­
      â”œâ”€ å­˜å‚¨ç©ºé—´ < storage_quota_mb â†’ âœ… ç»§ç»­
      â””â”€ è¶…é™ â†’ âŒ æ‹’ç»
      â†“
      å…‹éš†éŸ³è‰²
      â†“
      ä¿å­˜åˆ°æ•°æ®åº“ï¼š
      owner_id = forum_12345
```

---

## ğŸ“Š å®é™…æµ‹è¯•éªŒè¯

### æµ‹è¯•1ï¼šç”¨æˆ·éŸ³è‰²å¯¹åº”

```sql
-- ç”¨æˆ·12345å…‹éš†äº†éŸ³è‰²
INSERT INTO voices (
    voice_id='user_12345_voice_001',
    voice_name='å¼ ä¸‰çš„å£°éŸ³',
    owner_id='forum_12345',
    is_public=0
)

-- ç”¨æˆ·12345ä½¿ç”¨è‡ªå·±çš„éŸ³è‰²
SELECT * FROM voices 
WHERE voice_name='å¼ ä¸‰çš„å£°éŸ³' 
AND owner_id='forum_12345'
-- ç»“æœï¼šâœ… æ‰¾åˆ°éŸ³è‰²

-- ç”¨æˆ·67890å°è¯•ä½¿ç”¨ç”¨æˆ·12345çš„éŸ³è‰²
SELECT * FROM voices 
WHERE voice_name='å¼ ä¸‰çš„å£°éŸ³' 
AND owner_id='forum_67890'
-- ç»“æœï¼šâŒ æ‰¾ä¸åˆ°éŸ³è‰²ï¼ˆæƒé™æ‹’ç»ï¼‰
```

### æµ‹è¯•2ï¼šé…é¢ç®¡ç†

```sql
-- æ£€æŸ¥ç”¨æˆ·12345çš„éŸ³è‰²é…é¢
SELECT 
    (SELECT COUNT(*) FROM voices WHERE owner_id='forum_12345') as used,
    (SELECT voice_quota FROM users WHERE user_id='forum_12345') as quota

-- ç»“æœï¼šused=1, quota=20 â†’ âœ… å¯ä»¥ç»§ç»­å…‹éš†

-- æ£€æŸ¥å­˜å‚¨é…é¢
SELECT 
    (SELECT SUM(file_size_mb) FROM voices WHERE owner_id='forum_12345') as used,
    (SELECT storage_quota_mb FROM users WHERE user_id='forum_12345') as quota

-- ç»“æœï¼šused=8.5MB, quota=500MB â†’ âœ… ç©ºé—´å……è¶³
```

---

## ğŸ¯ æ€»ç»“

### å¦‚ä½•é˜²æ­¢å‡ºé”™ï¼Ÿ

1. **ç”¨æˆ·IDæ˜ å°„**
   - è®ºå›ID â†’ TTSç³»ç»ŸID (forum_å‰ç¼€)
   - æ•°æ®åº“å­˜å‚¨åŒé‡IDï¼ˆforum_user_id + user_idï¼‰
   - ç¡®ä¿å”¯ä¸€æ€§å’Œå¯è¿½æº¯æ€§

2. **éŸ³è‰²æ‰€æœ‰æƒ**
   - æ¯ä¸ªéŸ³è‰²éƒ½æœ‰owner_idå­—æ®µ
   - å¤–é”®çº¦æŸç¡®ä¿æ•°æ®ä¸€è‡´æ€§
   - æƒé™éªŒè¯ç¡®ä¿åªæœ‰æ‰€æœ‰è€…å¯ç”¨

3. **æœ¬åœ°æ•°æ®åº“**
   - æ‰€æœ‰å…³ç³»å­˜å‚¨åœ¨æœ¬åœ°SQLiteæ•°æ®åº“
   - å®æ—¶åŒæ­¥è®ºå›ç”¨æˆ·ä¿¡æ¯
   - å¿«é€ŸæŸ¥è¯¢å’ŒéªŒè¯

4. **ä¸‰é‡éªŒè¯**
   - æ•°æ®åº“å±‚ï¼šå¤–é”®çº¦æŸã€å”¯ä¸€æ€§çº¦æŸ
   - åº”ç”¨å±‚ï¼šæƒé™éªŒè¯ã€é…é¢éªŒè¯
   - ä¸šåŠ¡å±‚ï¼šç”¨æˆ·åŒæ­¥ã€éŸ³è‰²ç®¡ç†

### ç³»ç»Ÿå¯é æ€§

âœ… **å·²éªŒè¯çš„åŠŸèƒ½**ï¼š
- ç”¨æˆ·è‡ªåŠ¨åŒæ­¥
- éŸ³è‰²æ‰€æœ‰æƒç»‘å®š
- æƒé™éªŒè¯æ­£ç¡®
- é…é¢ç®¡ç†å‡†ç¡®
- æ•°æ®ä¸€è‡´æ€§ä¿è¯

âœ… **é˜²é”™æœºåˆ¶**ï¼š
- æ•°æ®åº“çº¦æŸé˜²æ­¢è„æ•°æ®
- æƒé™éªŒè¯é˜²æ­¢è¶Šæƒè®¿é—®
- é…é¢é™åˆ¶é˜²æ­¢æ»¥ç”¨
- å®æ—¶åŒæ­¥é˜²æ­¢æ•°æ®ä¸ä¸€è‡´

---

**ç»“è®º**ï¼šç³»ç»Ÿé€šè¿‡æ•°æ®åº“å…³è”ã€æƒé™éªŒè¯ã€é…é¢ç®¡ç†ä¸‰é‡æœºåˆ¶ï¼Œç¡®ä¿ç”¨æˆ·å’ŒéŸ³è‰²çš„ä¸€ä¸€å¯¹åº”å…³ç³»ï¼Œé˜²æ­¢å‡ºé”™ã€‚æ‰€æœ‰å…³é”®åŠŸèƒ½å·²é€šè¿‡æµ‹è¯•éªŒè¯ã€‚

