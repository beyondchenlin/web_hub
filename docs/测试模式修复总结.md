# æµ‹è¯•æ¨¡å¼ä¿®å¤æ€»ç»“

**ä¿®å¤æ—¶é—´**: 2025-11-03  
**ä¿®å¤ç‰ˆæœ¬**: 2.1.0

---

## ğŸ¯ ä¿®å¤ç›®æ ‡

è®©æµ‹è¯•æ¨¡å¼èƒ½å¤Ÿæ­£ç¡®ç›‘æ§ä¸‹è½½è®ºå›çš„å…¨éƒ¨å†…å®¹ï¼Œå¹¶ä»æºå¤´è§£å†³æ‰€æœ‰å‘ç°çš„é—®é¢˜ã€‚

---

## âœ… å·²ä¿®å¤çš„é—®é¢˜

### 1. æµ‹è¯•æ¨¡å¼ä¸ç”Ÿæ•ˆ âœ…

**é—®é¢˜æè¿°**ï¼š
- è™½ç„¶å‘½ä»¤è¡Œè®¾ç½®äº† `--test`ï¼Œä½†çˆ¬è™«ä»ç„¶ä½¿ç”¨ç”Ÿäº§æ¨¡å¼
- æ˜¾ç¤º"ğŸš€ ç”Ÿäº§æ¨¡å¼"è€Œä¸æ˜¯"ğŸ§ª æµ‹è¯•æ¨¡å¼"

**æ ¹æœ¬åŸå› **ï¼š
- `ForumCrawlerManager` ä»é…ç½®æ–‡ä»¶è¯»å– `test_mode`
- é…ç½®æ–‡ä»¶ä¸­æ²¡æœ‰ `test_mode` å­—æ®µ
- ç¯å¢ƒå˜é‡æœªè¢«è¯»å–

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- ä¿®æ”¹ `shared/forum_crawler_manager.py`
- ä»ç¯å¢ƒå˜é‡è¯»å– `FORUM_TEST_MODE` å’Œ `FORUM_TEST_ONCE`
- ç¯å¢ƒå˜é‡ä¼˜å…ˆçº§æœ€é«˜

**ä¿®å¤ä»£ç **ï¼š
```python
# shared/forum_crawler_manager.py (ç¬¬66-90è¡Œ)
def _build_crawler(self, forum_name: str) -> AicutForumCrawler:
    config = self._get_forum_config(forum_name)
    credentials = config.get("credentials", {})
    defaults = self._settings.get("credentials", {})

    # ğŸ”§ å…³é”®ä¿®å¤ï¼šä»ç¯å¢ƒå˜é‡è¯»å–æµ‹è¯•æ¨¡å¼é…ç½®ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
    test_mode = os.getenv('FORUM_TEST_MODE', 'false').lower() == 'true'
    test_once = os.getenv('FORUM_TEST_ONCE', 'false').lower() == 'true'
    
    # å¦‚æœç¯å¢ƒå˜é‡æœªè®¾ç½®ï¼Œåˆ™ä»é…ç½®æ–‡ä»¶è¯»å–
    if 'FORUM_TEST_MODE' not in os.environ:
        test_mode = config.get("test_mode", False)
    if 'FORUM_TEST_ONCE' not in os.environ:
        test_once = config.get("test_once", False)

    crawler = AicutForumCrawler(
        username=credentials.get("username") or defaults.get("username", ""),
        password=credentials.get("password") or defaults.get("password", ""),
        test_mode=test_mode,
        test_once=test_once,
        base_url=config.get("base_url", ""),
        forum_url=config.get("target_url", ""),
    )

    return crawler
```

---

### 2. ç™»å½•çŠ¶æ€åˆ¤æ–­ä¸å‡†ç¡® âœ…

**é—®é¢˜æè¿°**ï¼š
- ç™»å½•æˆåŠŸåæ˜¾ç¤º"âŒ ç™»å½•å¤±è´¥"
- ä½†å®é™…ä¸Šèƒ½å¤Ÿè·å–å®Œæ•´çš„å¸–å­å†…å®¹

**æ ¹æœ¬åŸå› **ï¼š
- Discuzè®ºå›ç™»å½•æˆåŠŸè¿”å›çš„æ˜¯é‡å®šå‘è„šæœ¬
- ä¸æ˜¯æ ‡å‡†çš„"ç™»å½•æˆåŠŸ"æ–‡æœ¬
- ç™»å½•åˆ¤æ–­é€»è¾‘ä¸å®Œå–„

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- ä¿®æ”¹ `web_hub/aicut_forum_crawler.py`
- è¯†åˆ«é‡å®šå‘è„šæœ¬ä½œä¸ºç™»å½•æˆåŠŸæ ‡å¿—
- æ£€æŸ¥session cookiesåˆ¤æ–­ç™»å½•çŠ¶æ€
- å¤„ç†503é™æµé”™è¯¯

**ä¿®å¤ä»£ç **ï¼š
```python
# web_hub/aicut_forum_crawler.py (ç¬¬204-241è¡Œ)
print(f"ğŸ“¥ ç™»å½•å“åº”çŠ¶æ€ç : {response.status_code}")

# ğŸ”§ å…³é”®ä¿®å¤ï¼šæ£€æŸ¥ç™»å½•æ˜¯å¦æˆåŠŸ
response_text = response.text

# æ£€æŸ¥æ˜¯å¦æœ‰æ˜ç¡®çš„é”™è¯¯ä¿¡æ¯
if 'å¯†ç é”™è¯¯' in response_text:
    print("âŒ ç™»å½•å¤±è´¥ï¼šå¯†ç é”™è¯¯")
    return False
elif 'ç”¨æˆ·åä¸å­˜åœ¨' in response_text:
    print("âŒ ç™»å½•å¤±è´¥ï¼šç”¨æˆ·åä¸å­˜åœ¨")
    return False
elif response.status_code == 503:
    print("âš ï¸ æœåŠ¡å™¨é™æµï¼ˆ503ï¼‰ï¼Œä½†å¯èƒ½å·²ç™»å½•")
    # æ£€æŸ¥cookiesåˆ¤æ–­æ˜¯å¦å·²ç™»å½•
    if any(cookie.name in ['cdb_sid', 'cdb_auth'] for cookie in self.session.cookies):
        self.logged_in = True
        print("âœ… æ£€æµ‹åˆ°ç™»å½•cookieï¼Œç™»å½•æˆåŠŸ")
        return True
    return False

# æ£€æŸ¥ç™»å½•æˆåŠŸçš„æ ‡å¿—
# 1. é‡å®šå‘è„šæœ¬ï¼ˆDiscuzå¸¸è§çš„ç™»å½•æˆåŠŸå“åº”ï¼‰
# 2. åŒ…å«ç”¨æˆ·å
# 3. åŒ…å«ç™»å½•æˆåŠŸæç¤º
# 4. æ£€æŸ¥cookie
if ('window.location.href' in response_text or  # é‡å®šå‘è„šæœ¬
    'reload="1"' in response_text or  # é‡è½½æ ‡å¿—
    'ç™»å½•æˆåŠŸ' in response_text or
    self.username in response_text or
    any(cookie.name in ['cdb_sid', 'cdb_auth'] for cookie in self.session.cookies)):
    self.logged_in = True
    print("âœ… ç™»å½•æˆåŠŸ")
    return True
else:
    print("âŒ ç™»å½•å¤±è´¥ï¼šæœªæ£€æµ‹åˆ°ç™»å½•æˆåŠŸæ ‡å¿—")
    print(f"å“åº”å†…å®¹å‰200å­—ç¬¦: {response_text[:200]}...")
    return False
```

---

### 3. é‡å¤ç™»å½•å°è¯•ï¼ˆå¯¼è‡´503é”™è¯¯ï¼‰âœ…

**é—®é¢˜æè¿°**ï¼š
- æ¯æ¬¡æ£€æŸ¥è®ºå›éƒ½å°è¯•é‡æ–°ç™»å½•
- å¯¼è‡´æœåŠ¡å™¨é™æµè¿”å›503é”™è¯¯
- æµªè´¹èµ„æºå’Œæ—¶é—´

**æ ¹æœ¬åŸå› **ï¼š
- `ForumCrawlerManager._ensure_logged_in()` åªæ£€æŸ¥ `logged_in` æ ‡å¿—
- æ²¡æœ‰æ£€æŸ¥sessionä¸­çš„ç™»å½•cookie
- å³ä½¿å·²æœ‰æœ‰æ•ˆcookieä¹Ÿä¼šé‡æ–°ç™»å½•

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- ä¿®æ”¹ `shared/forum_crawler_manager.py`
- æ£€æŸ¥session cookiesåˆ¤æ–­æ˜¯å¦å·²ç™»å½•
- é¿å…ä¸å¿…è¦çš„é‡å¤ç™»å½•

**ä¿®å¤ä»£ç **ï¼š
```python
# shared/forum_crawler_manager.py (ç¬¬102-116è¡Œ)
def _ensure_logged_in(self, crawler: AicutForumCrawler) -> None:
    """ç¡®ä¿çˆ¬è™«å·²ç™»å½•ï¼Œé¿å…é‡å¤ç™»å½•"""
    # æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
    if getattr(crawler, "logged_in", False):
        return
    
    # æ£€æŸ¥sessionä¸­æ˜¯å¦æœ‰æœ‰æ•ˆçš„ç™»å½•cookie
    if hasattr(crawler, 'session') and crawler.session:
        if any(cookie.name in ['cdb_sid', 'cdb_auth'] for cookie in crawler.session.cookies):
            # æœ‰ç™»å½•cookieï¼Œæ ‡è®°ä¸ºå·²ç™»å½•
            crawler.logged_in = True
            return
    
    # æœªç™»å½•ï¼Œæ‰§è¡Œç™»å½•
    crawler.login()
```

---

### 4. æ•°æ®åº“è·¯å¾„é—®é¢˜ âœ…

**é—®é¢˜æè¿°**ï¼š
```
ERROR:tts_forum_sync:âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: unable to open database file
```

**æ ¹æœ¬åŸå› **ï¼š
- æ•°æ®åº“è·¯å¾„ä½¿ç”¨ç›¸å¯¹è·¯å¾„ `database/tts_voice_system.db`
- ä» `web_hub` ç›®å½•å¯åŠ¨æ—¶ï¼Œç›¸å¯¹è·¯å¾„æŒ‡å‘é”™è¯¯ä½ç½®
- æ•°æ®åº“ç›®å½•ä¸å­˜åœ¨

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- ä¿®æ”¹ `tts/custom_integration/integration/tts_forum_sync.py`
- ä½¿ç”¨ç»å¯¹è·¯å¾„ï¼Œç›¸å¯¹äºå½“å‰æ–‡ä»¶æ‰€åœ¨ç›®å½•
- è‡ªåŠ¨åˆ›å»ºæ•°æ®åº“ç›®å½•

**ä¿®å¤ä»£ç **ï¼š
```python
# tts/custom_integration/integration/tts_forum_sync.py (ç¬¬23-56è¡Œ)
def __init__(self, db_path: str = "database/tts_voice_system.db"):
    """
    åˆå§‹åŒ–ç”¨æˆ·åŒæ­¥ç®¡ç†å™¨
    
    Args:
        db_path: æ•°æ®åº“è·¯å¾„
    """
    # ğŸ”§ å…³é”®ä¿®å¤ï¼šä½¿ç”¨ç»å¯¹è·¯å¾„ï¼Œç¡®ä¿æ•°æ®åº“æ–‡ä»¶å¯è®¿é—®
    if not os.path.isabs(db_path):
        # ç›¸å¯¹è·¯å¾„ï¼šç›¸å¯¹äºå½“å‰æ–‡ä»¶æ‰€åœ¨ç›®å½•
        current_dir = os.path.dirname(os.path.abspath(__file__))
        self.db_path = os.path.join(current_dir, db_path)
    else:
        self.db_path = db_path
    
    self._init_db()

def _init_db(self):
    """åˆå§‹åŒ–æ•°æ®åº“è¿æ¥"""
    try:
        # ç¡®ä¿æ•°æ®åº“ç›®å½•å­˜åœ¨
        db_dir = os.path.dirname(self.db_path)
        if db_dir and not os.path.exists(db_dir):
            os.makedirs(db_dir, exist_ok=True)
            logger.info(f"ğŸ“ åˆ›å»ºæ•°æ®åº“ç›®å½•: {db_dir}")
        
        conn = sqlite3.connect(self.db_path)
        conn.row_factory = sqlite3.Row
        conn.close()
        logger.info(f"âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ: {self.db_path}")
    except Exception as e:
        logger.error(f"âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: {e}")
        logger.error(f"   æ•°æ®åº“è·¯å¾„: {self.db_path}")
        raise
```

---

### 5. è®ºå›é›†æˆè°ƒç”¨æ–¹å¼ä¼˜åŒ– âœ…

**é—®é¢˜æè¿°**ï¼š
- ç›´æ¥è°ƒç”¨ `self.forum_crawler.monitor_new_posts()`
- ç»•è¿‡äº† `ForumCrawlerManager` çš„ç™»å½•æ£€æŸ¥

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- ä¿®æ”¹ `web_hub/lightweight/forum_integration.py`
- é€šè¿‡ `ForumCrawlerManager` è°ƒç”¨ï¼Œç¡®ä¿è‡ªåŠ¨ç™»å½•
- ä¿å­˜ manager å¼•ç”¨

**ä¿®å¤ä»£ç **ï¼š
```python
# web_hub/lightweight/forum_integration.py (ç¬¬77-102è¡Œ)
# åˆå§‹åŒ–è®ºå›çˆ¬è™« - ä½¿ç”¨ ForumCrawlerManager
self.forum_crawler = None
self.forum_crawler_manager = None  # ä¿å­˜ manager å¼•ç”¨
forum_parsing_enabled = getattr(config, 'forum_parsing_enabled', False)
if FORUM_CRAWLER_AVAILABLE and (self.forum_enabled or forum_parsing_enabled):
    try:
        print(f"ğŸ” ä½¿ç”¨ ForumCrawlerManager è·å–è®ºå›çˆ¬è™«å®ä¾‹...")

        # ä½¿ç”¨ ForumCrawlerManager è·å–çˆ¬è™«å®ä¾‹
        self.forum_crawler_manager = get_forum_crawler_manager()
        self.forum_crawler = self.forum_crawler_manager.get_crawler("main")
        # ...

# web_hub/lightweight/forum_integration.py (ç¬¬277-288è¡Œ)
try:
    print("ğŸ•·ï¸ è°ƒç”¨è®ºå›çˆ¬è™«ç›‘æ§æ–°å¸–...")
    # ğŸ”§ å…³é”®ä¿®å¤ï¼šé€šè¿‡ ForumCrawlerManager è°ƒç”¨ï¼Œç¡®ä¿è‡ªåŠ¨ç™»å½•
    if self.forum_crawler_manager:
        new_posts = self.forum_crawler_manager.monitor_new_posts("main")
    else:
        # å¤‡ç”¨ï¼šç›´æ¥è°ƒç”¨ï¼ˆä½†éœ€è¦æ‰‹åŠ¨ç¡®ä¿ç™»å½•ï¼‰
        if not self.forum_crawler.logged_in:
            print("ğŸ” è®ºå›æœªç™»å½•ï¼Œå°è¯•ç™»å½•...")
            self.forum_crawler.login()
        new_posts = self.forum_crawler.monitor_new_posts()
    print(f"ğŸ•·ï¸ è®ºå›çˆ¬è™«è¿”å› {len(new_posts)} ä¸ªåŸå§‹å¸–å­")
```

---

## ğŸ“Š ä¿®å¤æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | è¡Œæ•° |
|------|---------|------|
| `shared/forum_crawler_manager.py` | ä»ç¯å¢ƒå˜é‡è¯»å–æµ‹è¯•æ¨¡å¼ + ä¼˜åŒ–ç™»å½•æ£€æŸ¥ | +27è¡Œ |
| `web_hub/aicut_forum_crawler.py` | ä¼˜åŒ–ç™»å½•çŠ¶æ€åˆ¤æ–­é€»è¾‘ | +18è¡Œ |
| `tts/custom_integration/integration/tts_forum_sync.py` | ä¿®å¤æ•°æ®åº“è·¯å¾„é—®é¢˜ | +15è¡Œ |
| `web_hub/lightweight/forum_integration.py` | ä¼˜åŒ–è®ºå›é›†æˆè°ƒç”¨æ–¹å¼ | +12è¡Œ |

**æ€»è®¡**: 4ä¸ªæ–‡ä»¶ï¼Œ+72è¡Œä»£ç 

---

## ğŸ¯ ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰

```
ğŸ›ï¸ è¿è¡Œæ¨¡å¼: ğŸš€ ç”Ÿäº§æ¨¡å¼  âŒ
ğŸš€ ç”Ÿäº§æ¨¡å¼ï¼šåªæ£€æŸ¥æ–°å¸–å­  âŒ
âŒ ç™»å½•å¤±è´¥  âŒ
ğŸ“¥ ç™»å½•å“åº”çŠ¶æ€ç : 503  âŒ
ERROR: unable to open database file  âŒ
```

### ä¿®å¤å

```
ğŸ›ï¸ è¿è¡Œæ¨¡å¼: ğŸ§ª æµ‹è¯•æ¨¡å¼  âœ…
ğŸ§ª æµ‹è¯•æ¨¡å¼ï¼šæ£€æŸ¥æ‰€æœ‰å¸–å­  âœ…
âœ… ç™»å½•æˆåŠŸ  âœ…
ğŸ“¥ ç™»å½•å“åº”çŠ¶æ€ç : 200  âœ…
âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ  âœ…
```

---

## âœ… éªŒè¯ç»“æœ

### æµ‹è¯•æ¨¡å¼åŠŸèƒ½

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| æµ‹è¯•æ¨¡å¼å¯ç”¨ | âœ… | æ˜¾ç¤º"ğŸ§ª æµ‹è¯•æ¨¡å¼" |
| ä¸åŠ è½½å†å²è®°å½• | âœ… | æ¯æ¬¡é‡å¯éƒ½æ˜¯å…¨æ–°å¼€å§‹ |
| æ£€æŸ¥æ‰€æœ‰å¸–å­ | âœ… | ä¸è·³è¿‡å·²å¤„ç†çš„å¸–å­ |
| è®ºå›ç™»å½• | âœ… | æˆåŠŸç™»å½•å¹¶è·å–å†…å®¹ |
| è·å–å¸–å­åˆ—è¡¨ | âœ… | å‘ç°2ä¸ªå¸–å­ |
| è§£æå¸–å­è¯¦æƒ… | âœ… | æˆåŠŸè§£æè§†é¢‘å’ŒéŸ³é¢‘é“¾æ¥ |
| åˆ›å»ºä»»åŠ¡ | âœ… | æˆåŠŸåˆ›å»ºvoice_cloneä»»åŠ¡ |
| æŒç»­ç›‘æ§ | âœ… | æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡ |
| é¿å…é‡å¤ç™»å½• | âœ… | ä½¿ç”¨cookieä¿æŒä¼šè¯ |
| æ•°æ®åº“è®¿é—® | âœ… | æ­£ç¡®çš„ç»å¯¹è·¯å¾„ |

### å‘ç°çš„å¸–å­

**å¸–å­ #2**ï¼ˆæœ‰åª’ä½“å†…å®¹ï¼‰ï¼š
- è§†é¢‘: 2ä¸ª
- éŸ³é¢‘: 1ä¸ª
- ä»»åŠ¡ç±»å‹: voice_clone

**å¸–å­ #1**ï¼ˆæ— åª’ä½“å†…å®¹ï¼‰ï¼š
- çº¯æ–‡æœ¬å¸–å­

---

## ğŸŠ æ€»ç»“

æ‰€æœ‰é—®é¢˜éƒ½å·²ä»æºå¤´ä¿®å¤ï¼š

1. âœ… **æµ‹è¯•æ¨¡å¼** - ä»ç¯å¢ƒå˜é‡è¯»å–ï¼Œä¼˜å…ˆçº§æœ€é«˜
2. âœ… **ç™»å½•åˆ¤æ–­** - è¯†åˆ«é‡å®šå‘è„šæœ¬å’Œcookies
3. âœ… **é‡å¤ç™»å½•** - æ£€æŸ¥cookiesé¿å…é‡å¤
4. âœ… **æ•°æ®åº“è·¯å¾„** - ä½¿ç”¨ç»å¯¹è·¯å¾„å¹¶è‡ªåŠ¨åˆ›å»ºç›®å½•
5. âœ… **è°ƒç”¨æ–¹å¼** - é€šè¿‡Managerç¡®ä¿ç™»å½•

ç³»ç»Ÿç°åœ¨å¯ä»¥æ­£ç¡®åœ°ç›‘æ§ä¸‹è½½è®ºå›çš„å…¨éƒ¨å†…å®¹ï¼ğŸš€

